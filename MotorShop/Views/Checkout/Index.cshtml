@model MotorShop.ViewModels.CheckoutViewModel
@using MotorShop.Models.Enums
@inject Microsoft.Extensions.Options.IOptions<MotorShop.Utilities.PaymentSettings> PaymentOpts

@{
    ViewData["Title"] = "Thanh toán";

    var supportsCoupon = Model?.GetType().GetProperty("CouponCode") != null;
    var couponValue = supportsCoupon
        ? (Model?.GetType().GetProperty("CouponCode")!.GetValue(Model) as string)
        : null;

    var payCfg = PaymentOpts?.Value;
    var deposit = Model.DepositAmount ?? 0m;
    var remain = Model.Total - deposit;
}

@section Head{
    <style>
        body{
            background: radial-gradient(circle at top,#e0f2fe 0,#f9fafb 40%,#ffffff 100%);
        }
        .card-glass{
            background:rgba(255,255,255,.96);
            backdrop-filter:blur(16px) saturate(160%);
            border-radius:20px;
            border:1px solid rgba(148,163,184,.25);
            box-shadow:
                0 18px 40px rgba(15,23,42,.12),
                0 0 0 1px rgba(255,255,255,.6) inset;
        }
        .card-neon{
            position:relative;
        }
        .card-neon::before{
            content:"";
            position:absolute;
            inset:-1px;
            border-radius:22px;
            padding:1px;
            background:linear-gradient(135deg,#38bdf8,#4f46e5,#22c55e);
            -webkit-mask:
                linear-gradient(#000 0 0) content-box,
                linear-gradient(#000 0 0);
            -webkit-mask-composite:xor;
            mask-composite:exclude;
            opacity:0;
            transition:opacity .2s ease-out;
            pointer-events:none;
        }
        .card-neon--active::before{
            opacity:1;
        }
        .btn-3d{
            transform:translateZ(0);
            box-shadow:0 12px 30px rgba(37,99,235,.35);
            transition:all .18s ease-out;
        }
        .btn-3d:hover{
            transform:translateY(-1px);
            box-shadow:0 18px 40px rgba(37,99,235,.40);
        }
        .pill-badge{
            border-radius:999px;
            padding:3px 10px;
            font-size:11px;
            letter-spacing:.03em;
        }
        .bank-pill{
            border-radius:16px;
            border:1px solid rgba(148,163,184,.6);
            background:radial-gradient(circle at top,#f9fafb 0,#e5e7eb 80%);
            cursor:pointer;
            transition:all .18s ease-out;
        }
        .bank-pill:hover{
            box-shadow:0 0 0 1px rgba(59,130,246,.28),
                       0 14px 30px rgba(15,23,42,.18);
        }
        .bank-pill--active{
            border-color:#2563eb;
            box-shadow:0 0 0 1px rgba(59,130,246,.8),
                       0 18px 40px rgba(37,99,235,.45);
            background:radial-gradient(circle at top,#eff6ff 0,#e0ebff 70%);
        }
    </style>
}

<section class="relative py-10">
    <div aria-hidden="true" class="pointer-events-none absolute -top-10 -right-10 w-80 h-80 rounded-full blur-3xl bg-blue-200/50"></div>
    <div aria-hidden="true" class="pointer-events-none absolute -bottom-10 -left-10 w-80 h-80 rounded-full blur-3xl bg-cyan-200/40"></div>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 relative">
        <!-- Steps -->
        <div class="mb-6 flex items-center justify-between gap-4">
            <ol class="flex items-center gap-2 text-sm">
                <li class="flex items-center gap-2 text-sky-600 font-semibold">
                    <span class="w-6 h-6 grid place-items-center rounded-full bg-sky-600 text-white text-xs">1</span> Giỏ hàng
                </li>
                <span class="text-gray-400">—</span>
                <li class="flex items-center gap-2 text-sky-600 font-semibold">
                    <span class="w-6 h-6 grid place-items-center rounded-full bg-sky-600 text-white text-xs">2</span> Thông tin
                </li>
                <span class="text-gray-400">—</span>
                <li class="flex items-center gap-2 text-sky-700 font-semibold">
                    <span class="w-6 h-6 grid place-items-center rounded-full bg-emerald-500 text-white text-xs">3</span> Thanh toán
                </li>
                <span class="text-gray-400">—</span>
                <li class="flex items-center gap-2 text-gray-500">
                    <span class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 text-gray-700 text-xs">4</span> Hoàn tất
                </li>
            </ol>

            <span class="hidden sm:inline-flex items-center gap-2 text-xs text-sky-700 pill-badge bg-sky-50 border border-sky-200">
                <i class="fa-solid fa-bolt text-amber-400"></i>
                Các phương thức realtime qua QR VietQR
            </span>
        </div>

        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900 mb-6">
            Thanh toán &amp; đặt cọc
        </h1>

        <form asp-action="Index" asp-controller="Checkout" method="post" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            @Html.AntiForgeryToken()

            @* giữ danh sách sản phẩm chọn *@
            @if (Model.SelectedProductIds != null)
            {
                foreach (var id in Model.SelectedProductIds)
                {
                    <input type="hidden" name="SelectedProductIds" value="@id" />
                }
            }

            <!-- LEFT -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Người nhận -->
                <div class="card-glass p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="w-8 h-8 rounded-xl bg-sky-100 text-sky-700 grid place-items-center">
                                <i class="fa-regular fa-user"></i>
                            </span>
                            <h2 class="text-lg font-semibold">Thông tin người nhận</h2>
                        </div>
                        <div class="text-xs text-gray-500 flex items-center gap-1">
                            <i class="fa-solid fa-shield-halved text-emerald-500"></i> Kết nối an toàn, mã hoá SSL
                        </div>
                    </div>

                    <div class="grid sm:grid-cols-2 gap-4">
                        <div>
                            <label asp-for="ReceiverName" class="block text-sm font-medium text-gray-700"></label>
                            <input asp-for="ReceiverName" placeholder="Nguyễn Văn A"
                                   class="mt-1 w-full border-gray-300 rounded-xl shadow-sm focus:ring-sky-500 focus:border-sky-500" />
                            <span asp-validation-for="ReceiverName" class="text-sm text-red-600"></span>
                        </div>
                        <div>
                            <label asp-for="ReceiverPhone" class="block text-sm font-medium text-gray-700"></label>
                            <input asp-for="ReceiverPhone" inputmode="tel" placeholder="09xx xxx xxx"
                                   class="mt-1 w-full border-gray-300 rounded-xl shadow-sm focus:ring-sky-500 focus:border-sky-500" />
                            <span asp-validation-for="ReceiverPhone" class="text-sm text-red-600"></span>
                        </div>
                        <div class="sm:col-span-2">
                            <label asp-for="ReceiverEmail" class="block text-sm font-medium text-gray-700"></label>
                            <input asp-for="ReceiverEmail" type="email" placeholder="you@example.com"
                                   class="mt-1 w-full border-gray-300 rounded-xl shadow-sm focus:ring-sky-500 focus:border-sky-500" />
                            <span asp-validation-for="ReceiverEmail" class="text-sm text-red-600"></span>
                        </div>
                        <div class="sm:col-span-2">
                            <label asp-for="CustomerNote" class="block text-sm font-medium text-gray-700"></label>
                            <textarea asp-for="CustomerNote" rows="2" placeholder="Lưu ý cho shipper/nhân viên..."
                                      class="mt-1 w-full border-gray-300 rounded-xl shadow-sm focus:ring-sky-500 focus:border-sky-500"></textarea>
                            <span asp-validation-for="CustomerNote" class="text-sm text-red-600"></span>
                        </div>
                    </div>
                </div>

                <!-- Hình thức nhận hàng -->
                <div class="card-glass p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="w-8 h-8 rounded-xl bg-violet-100 text-violet-700 grid place-items-center">
                            <i class="fa-solid fa-location-dot"></i>
                        </span>
                        <h2 class="text-lg font-semibold">Hình thức nhận xe</h2>
                    </div>

                    <div class="grid sm:grid-cols-2 gap-3">
                        <label class="card-neon border rounded-2xl p-4 flex items-start gap-3 cursor-pointer hover:bg-slate-50"
                               data-delivery-card="@((int)DeliveryMethod.HomeDelivery)">
                            <input type="radio" name="DeliveryMethod" value="@((int)DeliveryMethod.HomeDelivery)"
                                   @(Model.DeliveryMethod == DeliveryMethod.HomeDelivery ? "checked" : null)
                                   onchange="onDeliveryChange(this.value)"
                                   class="mt-1 text-sky-600" />
                            <div>
                                <div class="font-semibold text-slate-900 flex items-center gap-2">
                                    <i class="fa-solid fa-truck-fast text-sky-500"></i> Giao tận nơi
                                </div>
                                <div class="mt-1 text-sm text-gray-500">
                                    Phí giao chuẩn toàn quốc, hiển thị ở phần tóm tắt.
                                </div>
                            </div>
                        </label>

                        <label class="card-neon border rounded-2xl p-4 flex items-start gap-3 cursor-pointer hover:bg-slate-50"
                               data-delivery-card="@((int)DeliveryMethod.PickupAtStore)">
                            <input type="radio" name="DeliveryMethod" value="@((int)DeliveryMethod.PickupAtStore)"
                                   @(Model.DeliveryMethod == DeliveryMethod.PickupAtStore ? "checked" : null)
                                   onchange="onDeliveryChange(this.value)"
                                   class="mt-1 text-sky-600" />
                            <div>
                                <div class="font-semibold text-slate-900 flex items-center gap-2">
                                    <i class="fa-solid fa-building-store text-emerald-500"></i> Nhận tại cửa hàng
                                    <span class="pill-badge bg-emerald-50 text-emerald-700 border border-emerald-200">
                                        Free ship
                                    </span>
                                </div>
                                <div class="mt-1 text-sm text-gray-500">
                                    Miễn phí giao xe, có thể yêu cầu đặt cọc trước.
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- địa chỉ -->
                    <div id="shipBox" class="mt-4 @(Model.DeliveryMethod == DeliveryMethod.HomeDelivery ? "" : "hidden")">
                        <label asp-for="ShippingAddress" class="block text-sm font-medium text-gray-700"></label>
                        <input asp-for="ShippingAddress" placeholder="Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành"
                               class="mt-1 w-full border-gray-300 rounded-xl shadow-sm focus:ring-sky-500 focus:border-sky-500" />
                        <span asp-validation-for="ShippingAddress" class="text-sm text-red-600"></span>
                    </div>

                    <!-- chi nhánh -->
                    <div id="pickupBox" class="mt-4 space-y-3 @(Model.DeliveryMethod == DeliveryMethod.PickupAtStore ? "" : "hidden")">
                        <label class="block text-sm font-medium text-gray-700">Chi nhánh nhận xe</label>
                        <select id="PickupBranchId" name="PickupBranchId"
                                class="w-full border-gray-300 rounded-xl shadow-sm focus:ring-sky-500 focus:border-sky-500"
                                onchange="updateBranchInfo()">
                            <option value="">-- Chọn chi nhánh --</option>
                            @foreach (var br in Model.Branches)
                            {
                                <option value="@br.Id" data-name="@br.Name" data-address="@br.Address">@br.Name</option>
                            }
                        </select>
                        <span asp-validation-for="PickupBranchId" class="text-sm text-red-600"></span>

                        <div id="branchCard" class="hidden rounded-xl border bg-sky-50/60 p-3 text-sm">
                            <div class="font-semibold text-slate-800" data-name>—</div>
                            <div class="text-gray-600 mt-0.5" data-address>—</div>
                        </div>
                    </div>
                </div>

                <!-- Phương thức thanh toán -->
                <div class="card-glass p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="w-8 h-8 rounded-xl bg-indigo-100 text-indigo-600 grid place-items-center">
                                <i class="fa-solid fa-credit-card"></i>
                            </span>
                            <h2 class="text-lg font-semibold">Phương thức thanh toán</h2>
                        </div>
                        <span class="pill-badge bg-slate-900 text-slate-50 flex items-center gap-1">
                            <i class="fa-solid fa-lock"></i> 3D Secure demo
                        </span>
                    </div>

                    <div class="grid sm:grid-cols-2 gap-3 mb-4">
                        <!-- Thẻ ngân hàng -->
                        <label class="card-neon border rounded-2xl p-4 flex items-start gap-3 cursor-pointer hover:bg-slate-50"
                               data-payment-card="@((int)PaymentMethod.Card)">
                            <input type="radio" name="PaymentMethod" value="@((int)PaymentMethod.Card)"
                                   @(Model.PaymentMethod == PaymentMethod.Card ? "checked" : null)
                                   onchange="onPaymentChange(this.value)"
                                   class="mt-1 text-sky-600" />
                            <div>
                                <div class="font-semibold text-slate-900 flex items-center gap-2">
                                    <i class="fa-regular fa-credit-card text-sky-500"></i>
                                    Thẻ ngân hàng (Visa / ATM)
                                </div>
                                <p class="mt-1 text-sm text-gray-500">
                                    Thanh toán 100% bằng thẻ, mô phỏng cổng thanh toán online.
                                </p>
                            </div>
                        </label>

                        <!-- Chuyển khoản / QR ngân hàng -->
                        <label class="card-neon border rounded-2xl p-4 flex items-start gap-3 cursor-pointer hover:bg-slate-50"
                               data-payment-card="@((int)PaymentMethod.BankTransfer)">
                            <input type="radio" name="PaymentMethod" value="@((int)PaymentMethod.BankTransfer)"
                                   @(Model.PaymentMethod == PaymentMethod.BankTransfer ? "checked" : null)
                                   onchange="onPaymentChange(this.value)"
                                   class="mt-1 text-sky-600" />
                            <div>
                                <div class="font-semibold text-slate-900 flex items-center gap-2">
                                    <i class="fa-solid fa-qrcode text-indigo-500"></i>
                                    Chuyển khoản / QR ngân hàng
                                </div>
                                <p class="mt-1 text-sm text-gray-500">
                                    Thanh toán 100% qua VietQR, tự điền STK &amp; nội dung.
                                </p>
                            </div>
                        </label>

                        <!-- COD -->
                        <label class="card-neon border rounded-2xl p-4 flex items-start gap-3 cursor-pointer hover:bg-slate-50"
                               data-payment-card="@((int)PaymentMethod.CashOnDelivery)">
                            <input type="radio" name="PaymentMethod" value="@((int)PaymentMethod.CashOnDelivery)"
                                   @(Model.PaymentMethod == PaymentMethod.CashOnDelivery ? "checked" : null)
                                   onchange="onPaymentChange(this.value)"
                                   class="mt-1 text-sky-600" />
                            <div>
                                <div class="font-semibold text-slate-900 flex items-center gap-2">
                                    <i class="fa-solid fa-money-bill-wave text-emerald-500"></i>
                                    Thanh toán khi nhận (COD)
                                </div>
                                <p class="mt-1 text-sm text-gray-500">Thanh toán tiền mặt cho nhân viên giao xe.</p>
                            </div>
                        </label>

                        <!-- Đặt cọc & thanh toán tại cửa hàng -->
                        <label class="card-neon border rounded-2xl p-4 flex items-start gap-3 cursor-pointer hover:bg-slate-50"
                               data-payment-card="@((int)PaymentMethod.PayAtStore)">
                            <input type="radio" name="PaymentMethod" value="@((int)PaymentMethod.PayAtStore)"
                                   @(Model.PaymentMethod == PaymentMethod.PayAtStore ? "checked" : null)
                                   onchange="onPaymentChange(this.value)"
                                   class="mt-1 text-sky-600" />
                            <div>
                                <div class="font-semibold text-slate-900 flex items-center gap-2">
                                    <i class="fa-solid fa-building-columns text-amber-500"></i>
                                    Đặt cọc &amp; thanh toán tại cửa hàng
                                </div>
                                <p class="mt-1 text-sm text-gray-500">
                                    Đặt cọc (ví dụ 50%) qua QR, phần còn lại thanh toán tại quầy.
                                </p>
                            </div>
                        </label>
                    </div>

                    <!-- logo hỗ trợ -->
                    <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-gray-500">
                        <span>Hỗ trợ:</span>
                        <span class="pill-badge bg-white border text-slate-700 inline-flex items-center gap-1">
                            <img src="/images/payments/visa.svg" class="h-4" alt="Visa" /> VISA
                        </span>
                        <span class="pill-badge bg-white border text-slate-700 inline-flex items-center gap-1">
                            <img src="/images/payments/mastercard.svg" class="h-4" alt="Mastercard" /> Mastercard
                        </span>
                        <span class="pill-badge bg-white border text-slate-700 inline-flex items-center gap-1">
                            <img src="/images/payments/momo.svg" class="h-4" alt="MoMo" /> MoMo
                        </span>
                        <span class="pill-badge bg-white border text-slate-700 inline-flex items-center gap-1">
                            <img src="/images/payments/vnpay.svg" class="h-4" alt="VNPay" /> VNPay
                        </span>
                        <span class="pill-badge bg-white border text-slate-700 inline-flex items-center gap-1">
                            <img src="/images/payments/ibanking.svg" class="h-4" alt="iBanking" /> iBanking
                        </span>
                    </div>

                    <!-- Ngân hàng cho QR / đặt cọc -->
                    <div id="bankBox"
                         class="mt-6 @(Model.PaymentMethod is PaymentMethod.BankTransfer or PaymentMethod.PayAtStore ? "" : "hidden")">
                        <h3 class="text-sm font-semibold text-slate-800 mb-3">
                            Ngân hàng thanh toán / nhận cọc
                        </h3>

                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            @foreach (var bank in Model.Banks)
                            {
                                var isSel = !string.IsNullOrWhiteSpace(Model.SelectedBankCode)
                                            && string.Equals(Model.SelectedBankCode, bank.Code, StringComparison.OrdinalIgnoreCase);
                                var logo = !string.IsNullOrWhiteSpace(bank.LogoUrl)
                                    ? bank.LogoUrl
                                    : $"/images/banks/{bank.Code?.ToLower()}.svg";

                                <label class="bank-pill flex items-center gap-3 p-3 @(isSel ? "bank-pill--active" : "")"
                                       data-bank-code="@bank.Code">
                                    <input type="radio" name="SelectedBankCode" value="@bank.Code" class="hidden" @(isSel ? "checked" : null) />
                                    <img src="@logo" alt="@bank.Name" class="h-6 w-6 object-contain" />
                                    <span class="text-xs sm:text-sm font-medium leading-snug">@bank.Name</span>
                                </label>
                            }
                        </div>

                        @if (payCfg != null)
                        {
                            <div class="mt-3 text-xs text-gray-600 space-y-0.5">
                                <div>Chủ tài khoản: <b>@payCfg.AccountName</b></div>
                                <div>Số tài khoản: <b>@payCfg.AccountNumber</b> (@payCfg.BankCode?.ToUpper())</div>
                            </div>
                        }

                        <div id="depositHint" class="mt-4 hidden rounded-xl border border-sky-200 bg-sky-50/80 p-3 text-sm text-sky-900">
                            <div class="font-semibold mb-1">
                                Cần đặt cọc trước khoảng <span id="depositHintAmount">0</span> ₫
                            </div>
                            <div>
                                Phần còn lại thanh toán khi nhận xe / tại quầy tuỳ phương thức.
                            </div>
                        </div>
                    </div>

                    <!-- Thông tin thẻ -->
                    <div id="cardBox" class="mt-6 @(Model.PaymentMethod == PaymentMethod.Card ? "" : "hidden")">
                        <h3 class="text-sm font-semibold text-slate-800 mb-3">
                            Thông tin thẻ ngân hàng
                        </h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label asp-for="CardHolder" class="block text-sm font-medium text-gray-700"></label>
                                <input asp-for="CardHolder" placeholder="Nguyen Van A"
                                       class="mt-1 w-full border-gray-300 rounded-xl shadow-sm focus:ring-sky-500 focus:border-sky-500" />
                                <span asp-validation-for="CardHolder" class="text-sm text-red-600"></span>
                            </div>
                            <div>
                                <label asp-for="CardExpiry" class="block text-sm font-medium text-gray-700"></label>
                                <input asp-for="CardExpiry" placeholder="MM/YY" inputmode="numeric"
                                       class="mt-1 w-full border-gray-300 rounded-xl shadow-sm focus:ring-sky-500 focus:border-sky-500" />
                                <span asp-validation-for="CardExpiry" class="text-sm text-red-600"></span>
                            </div>
                            <div class="sm:col-span-2">
                                <label asp-for="CardNumber" class="block text-sm font-medium text-gray-700"></label>
                                <input asp-for="CardNumber" placeholder="9704 xxxx xxxx xxxx" inputmode="numeric" maxlength="19"
                                       class="mt-1 w-full border-gray-300 rounded-xl shadow-sm focus:ring-sky-500 focus:border-sky-500" />
                                <span asp-validation-for="CardNumber" class="text-sm text-red-600"></span>
                            </div>
                        </div>
                    </div>

                    <!-- COD -->
                    <div id="codBox" class="mt-6 text-sm text-gray-600 @(Model.PaymentMethod == PaymentMethod.CashOnDelivery ? "" : "hidden")">
                        <div class="rounded-xl border bg-slate-50 p-3">
                            <div class="font-semibold mb-1">Thanh toán khi nhận hàng (COD)</div>
                            <p class="mb-1">Bạn thanh toán tiền mặt trực tiếp cho nhân viên giao xe.</p>
                            <p class="text-xs text-gray-500">
                                Một số khu vực xa có thể yêu cầu đặt cọc trước qua chuyển khoản/QR, nhân viên sẽ liên hệ nếu cần.
                            </p>
                        </div>
                    </div>

                    <!-- Pay at store -->
                    <div id="storeBox" class="mt-6 text-sm text-gray-600 @(Model.PaymentMethod == PaymentMethod.PayAtStore ? "" : "hidden")">
                        <div class="rounded-xl border bg-slate-50 p-3">
                            <div class="font-semibold mb-1">Đặt cọc &amp; thanh toán tại cửa hàng</div>
                            <p class="mb-1">
                                Bạn đặt cọc trước (ví dụ 50%) qua QR/chuyển khoản, phần còn lại thanh toán tại quầy thu ngân.
                            </p>
                            <p class="text-xs text-gray-500">
                                Vui lòng chọn đúng <b>chi nhánh nhận xe</b> ở phần hình thức nhận hàng phía trên.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: summary & QR -->
            <aside class="lg:col-span-1">
                <div class="sticky top-24 space-y-4">
                    <div class="card-glass overflow-hidden">
                        <div class="px-6 py-4 border-b bg-gradient-to-r from-sky-100 via-indigo-100 to-emerald-100">
                            <h3 class="text-lg font-semibold flex items-center gap-2 text-slate-900">
                                <i class="fa-solid fa-receipt text-sky-600"></i> Đơn hàng của bạn
                            </h3>
                        </div>

                        <!-- items -->
                        <div class="px-6 py-4 space-y-3 max-h-[230px] overflow-auto">
                            @foreach (var it in Model.Items)
                            {
                                @await Html.PartialAsync("_CheckoutItemRow",
                                    new MotorShop.ViewModels.CheckoutLineVm {
                                        Name = it.ProductName, Quantity = it.Quantity, UnitPrice = it.Price, ImageUrl = it.ImageUrl
                                    },
                                    new ViewDataDictionary(ViewData) {["mode"] = "card"})
                            }
                        </div>

                        @if (supportsCoupon)
                        {
                            <div class="px-6 pt-2 border-t">
                                <label class="text-sm font-semibold text-gray-700">Mã giảm giá</label>
                                <div class="mt-2 flex gap-2">
                                    <input type="text" name="CouponCode" value="@couponValue"
                                           placeholder="Nhập mã (VD: MOTOR5)"
                                           class="flex-1 border-gray-300 rounded-xl shadow-sm focus:ring-sky-500 focus:border-sky-500" />
                                    <button type="submit"
                                            class="px-4 rounded-xl border font-semibold hover:bg-slate-50">
                                        Áp dụng
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Mã sẽ được kiểm tra &amp; áp dụng khi xác nhận đơn.</p>
                            </div>
                        }

                        <!-- summary numbers -->
                        <div class="px-6 py-4 border-t space-y-2 text-sm">
                            <div class="flex justify-between text-gray-600">
                                <span>Tạm tính</span>
                                <span id="summarySubtotal">@Model.Subtotal.ToString("#,0") ₫</span>
                            </div>
                            <div class="flex justify-between text-gray-600">
                                <span>Phí vận chuyển</span>
                                <span id="summaryShipping">
                                    @(Model.ShippingFee == 0 ? "Miễn phí" : Model.ShippingFee.ToString("#,0") + " ₫")
                                </span>
                            </div>
                            <div class="flex justify-between text-gray-600">
                                <span>Giảm giá</span>
                                <span id="summaryDiscount">-@Model.DiscountAmount.ToString("#,0") ₫</span>
                            </div>

                            <div id="summaryDepositBox"
                                 class="mt-2 rounded-xl bg-sky-50 px-3 py-2 text-xs text-sky-900 space-y-0.5 @(Model.RequiresDeposit && Model.DepositAmount.HasValue ? "" : "hidden")">
                                <div class="flex justify-between">
                                    <span>Cần đặt cọc</span>
                                    <span class="font-semibold" id="summaryDepositAmount">
                                        @Model.DepositAmount?.ToString("#,0") ₫
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Còn lại khi nhận xe</span>
                                    <span class="font-semibold" id="summaryRemainAmount">
                                        @remain.ToString("#,0") ₫
                                    </span>
                                </div>
                            </div>

                            <div class="h-px bg-gray-200 my-2"></div>
                            <div class="flex justify-between text-base font-semibold">
                                <span>Tổng cộng</span>
                                <span class="text-slate-900" id="summaryTotal">@Model.Total.ToString("#,0") ₫</span>
                            </div>
                        </div>

                        <!-- QR bên phải -->
                        <div class="px-6 pb-4 border-t">
                            <div id="qrPanel"
                                 class="mt-3 rounded-2xl border border-slate-200 bg-slate-50/80 p-3 text-center hidden">
                                <p class="text-sm font-semibold text-slate-800 mb-1" id="qrTitle">
                                    Mã QR thanh toán / đặt cọc
                                </p>
                                <img id="qrImage"
                                     alt="QR thanh toán"
                                     class="inline-block max-w-[220px] w-full rounded-xl border border-white shadow" />
                                <p class="mt-2 text-xs text-gray-600" id="qrCaption">
                                    Quét bằng ứng dụng ngân hàng / MoMo / VNPay để thanh toán.
                                </p>
                            </div>

                            <button id="btnSubmit" type="submit"
                                    class="mt-4 w-full py-3 bg-gradient-to-r from-sky-600 via-indigo-600 to-emerald-500 text-white rounded-xl font-semibold btn-3d inline-flex items-center justify-center gap-2">
                                <i class="fa-solid fa-lock"></i>
                                <span> Xác nhận &amp; Thanh toán</span>
                            </button>
                            <p class="text-[11px] text-gray-500 mt-2 text-center">
                                Nhấn nút trên đồng nghĩa bạn đồng ý với chính sách đặt cọc &amp; điều khoản của MotorShop.
                            </p>
                        </div>
                    </div>

                    <a asp-controller="Cart" asp-action="Index"
                       class="block text-center text-sm text-sky-700 hover:text-sky-800 font-medium">
                        ← Điều chỉnh giỏ hàng
                    </a>
                </div>
            </aside>
        </form>
    </div>
</section>

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
    <script>
        const DELIVERY_HOME  = '@((int)DeliveryMethod.HomeDelivery)';
        const DELIVERY_STORE = '@((int)DeliveryMethod.PickupAtStore)';

        const PAY_CARD   = '@((int)PaymentMethod.Card)';
        const PAY_TRANS  = '@((int)PaymentMethod.BankTransfer)';
        const PAY_COD    = '@((int)PaymentMethod.CashOnDelivery)';
        const PAY_STORE  = '@((int)PaymentMethod.PayAtStore)';

        const SUBTOTAL  = @Model.Subtotal;
        const DISCOUNT  = @Model.DiscountAmount;
        const SHIP_HOME = 30000; // giống CalculateShipping
        const SHIP_STORE = 0;
        const DEPOSIT_PERCENT = 0.5;

        const BANK_CODE  = '@(payCfg?.BankCode ?? "")';
        const BANK_ACC   = '@(payCfg?.AccountNumber ?? "")';
        const BANK_NAME  = encodeURIComponent('@(payCfg?.AccountName ?? "")');

        function money(v){
            return v.toLocaleString('vi-VN');
        }

        function currentDelivery(){
            return document.querySelector('input[name="DeliveryMethod"]:checked')?.value ?? DELIVERY_HOME;
        }

        function currentPayment(){
            return document.querySelector('input[name="PaymentMethod"]:checked')?.value ?? PAY_CARD;
        }

        function onDeliveryChange(val){
            const ship = document.getElementById('shipBox');
            const pick = document.getElementById('pickupBox');
            if(String(val) === DELIVERY_HOME){
                ship?.classList.remove('hidden');
                pick?.classList.add('hidden');
            } else {
                ship?.classList.add('hidden');
                pick?.classList.remove('hidden');
                updateBranchInfo();
            }
            updateNeonCards();
            recalcSummaryAndQr();
        }

        function onPaymentChange(val){
            const bank  = document.getElementById('bankBox');
            const card  = document.getElementById('cardBox');
            const cod   = document.getElementById('codBox');
            const store = document.getElementById('storeBox');

            const v = String(val);

            bank?.classList.toggle('hidden', !(v === PAY_TRANS || v === PAY_STORE));
            card?.classList.toggle('hidden', v !== PAY_CARD);
            cod?.classList.toggle('hidden', v !== PAY_COD);
            store?.classList.toggle('hidden', v !== PAY_STORE);

            updateNeonCards();
            recalcSummaryAndQr();
        }

        function updateBranchInfo(){
            const sel  = document.getElementById('PickupBranchId');
            const card = document.getElementById('branchCard');
            if(!sel || !card) return;
            const opt = sel.options[sel.selectedIndex];
            const name = opt?.dataset?.name || "";
            const address = opt?.dataset?.address || "";
            card.querySelector('[data-name]').textContent = name || "—";
            card.querySelector('[data-address]').textContent = address || "—";
            card.classList.toggle('hidden', !opt || !opt.value);
        }

        function updateNeonCards(){
            // delivery
            document.querySelectorAll('[data-delivery-card]').forEach(el=>{
                const val = el.getAttribute('data-delivery-card');
                el.classList.toggle('card-neon--active', val === currentDelivery());
            });
            // payment
            document.querySelectorAll('[data-payment-card]').forEach(el=>{
                const val = el.getAttribute('data-payment-card');
                el.classList.toggle('card-neon--active', val === currentPayment());
            });
            // bank pills
            document.querySelectorAll('.bank-pill').forEach(el=>{
                const input = el.querySelector('input[type="radio"]');
                el.classList.toggle('bank-pill--active', input && input.checked);
            });
        }

        function recalcSummaryAndQr(){
            const delivery = currentDelivery();
            const payment  = currentPayment();

            const shipping = delivery === DELIVERY_HOME ? SHIP_HOME : SHIP_STORE;
            const subtotal = SUBTOTAL;
            const total    = subtotal + shipping - DISCOUNT;

            // số trên panel
            const shipSpan = document.getElementById('summaryShipping');
            if (shipping === 0){
                shipSpan.textContent = 'Miễn phí';
            } else {
                shipSpan.textContent = money(shipping) + ' ₫';
            }

            document.getElementById('summarySubtotal').textContent = money(subtotal) + ' ₫';
            document.getElementById('summaryTotal').textContent    = money(total) + ' ₫';

            // đặt cọc khi nhận tại cửa hàng
            const needDeposit = (delivery === DELIVERY_STORE);
            const depositBox  = document.getElementById('summaryDepositBox');
            const depositHint = document.getElementById('depositHint');
            let deposit = 0;
            if (needDeposit){
                deposit = Math.round(total * DEPOSIT_PERCENT);
                const remain = total - deposit;
                depositBox?.classList.remove('hidden');
                depositHint?.classList.remove('hidden');
                document.getElementById('summaryDepositAmount').textContent = money(deposit) + ' ₫';
                document.getElementById('summaryRemainAmount').textContent  = money(remain) + ' ₫';
                document.getElementById('depositHintAmount').textContent    = money(deposit);
            }else{
                depositBox?.classList.add('hidden');
                depositHint?.classList.add('hidden');
            }

            // QR: chỉ cho BankTransfer & PayAtStore
            const qrPanel  = document.getElementById('qrPanel');
            const qrImage  = document.getElementById('qrImage');
            const qrTitle  = document.getElementById('qrTitle');
            const qrCap    = document.getElementById('qrCaption');

            if ((payment === PAY_TRANS || payment === PAY_STORE) && BANK_CODE && BANK_ACC){
                const amount = needDeposit ? deposit : total;
                const nameInput = document.querySelector('input[name="ReceiverName"]');
                const cusName = encodeURIComponent((nameInput?.value || '').trim());
                const info = cusName
                    ? `Thanh toan MotorShop ${cusName}`
                    : 'Thanh toan MotorShop';
                const encodedInfo = encodeURIComponent(info);

                const url = `https://img.vietqr.io/image/${BANK_CODE}-${BANK_ACC}-compact2.png` +
                            `?amount=${amount}&addInfo=${encodedInfo}&accountName=${BANK_NAME}`;

                qrImage.src = url;
                qrTitle.textContent = needDeposit
                    ? 'Mã QR thanh toán tiền đặt cọc'
                    : 'Mã QR thanh toán toàn bộ đơn hàng';
                qrCap.textContent = `Số tiền: ${money(amount)} ₫ – Quét bằng ứng dụng ngân hàng / MoMo / VNPay để thanh toán.`;
                qrPanel.classList.remove('hidden');
            }else{
                qrPanel.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sel = document.getElementById('PickupBranchId');
            if (sel) {
                sel.value = '@(Model.PickupBranchId?.ToString() ?? "")';
                updateBranchInfo();
            }

            // init neon + summary + QR
            updateNeonCards();
            recalcSummaryAndQr();

            // format số thẻ
            const cardInput = document.querySelector('input[name="CardNumber"]');
            if(cardInput){
                cardInput.addEventListener('input', () => {
                    const raw = cardInput.value.replace(/\D/g,'').slice(0,19);
                    cardInput.value = raw.replace(/(.{4})/g,'$1 ').trim();
                });
            }

            // chọn bank -> neon
            document.querySelectorAll('.bank-pill input[type="radio"]').forEach(r=>{
                r.addEventListener('change', updateNeonCards);
            });

            // đổi tên người nhận -> update QR nội dung
            const nameInput = document.querySelector('input[name="ReceiverName"]');
            if(nameInput){
                nameInput.addEventListener('blur', recalcSummaryAndQr);
            }

            // chống double submit
            const btn = document.getElementById('btnSubmit');
            if(btn){
                btn.closest('form')?.addEventListener('submit', () => {
                    btn.disabled = true;
                    btn.classList.add('opacity-70');
                    const icon = btn.querySelector('i');
                    if(icon){ icon.className = 'fa-solid fa-spinner animate-spin'; }
                });
            }
        });
    </script>
}
