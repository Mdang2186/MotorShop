@using Microsoft.AspNetCore.Identity
@using MotorShop.Models
@using MotorShop.Utilities
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject MotorShop.Services.CartService CartService

@{
    var cartItemCount = CartService.GetCartItems().Sum(i => i.Quantity);
}

<div class="flex items-center space-x-4">
    <a asp-controller="Cart" asp-action="Index" class="relative p-2 text-gray-600 hover:text-blue-600">
        <i class="fas fa-shopping-cart text-xl"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center @(cartItemCount == 0 ? "hidden" : "")">
            @cartItemCount
        </span>
    </a>

    @if (SignInManager.IsSignedIn(User))
    {
        // Lấy thông tin đầy đủ của người dùng một cách an toàn
        var user = await UserManager.GetUserAsync(User);

        <div class="relative group">
            <div class="flex items-center space-x-2 text-gray-600 cursor-pointer">
                <i class="fas fa-user-circle text-xl"></i>
                @* Kiểm tra xem user có tồn tại không trước khi hiển thị tên *@
                <span class="hidden md:block font-medium">@(user?.FullName ?? user?.UserName)</span>
            </div>

            <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden group-hover:block">
                @if (User.IsInRole(SD.Role_Admin))
                {
                    <a asp-area="Admin" asp-controller="Dashboard" asp-action="Index" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-tachometer-alt w-4 mr-2"></i>Trang Quản trị
                    </a>
                }
                <a asp-controller="Order" asp-action="History" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-history w-4 mr-2"></i>Lịch sử đơn hàng
                </a>
                <div class="border-t my-1"></div>
                <form asp-controller="Account" asp-action="Logout" method="post" class="w-full">
                    <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-sign-out-alt w-4 mr-2"></i>Đăng xuất
                    </button>
                </form>
            </div>
        </div>
    }
    else
    {
        <div class="flex items-center space-x-2">
            <a class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium" asp-controller="Account" asp-action="Login">
                Đăng nhập
            </a>
            <a class="bg-blue-600 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700" asp-controller="Account" asp-action="Register">
                Đăng ký
            </a>
        </div>
    }
</div>