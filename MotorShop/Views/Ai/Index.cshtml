@{
    ViewData["Title"] = "Magic AI - MotorShop";
}

@section Head {
    <style>
        /* --- 1. MAGIC BACKGROUND ANIMATION --- */
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0f172a;
        }

        /* Nền chuyển động màu sắc (Mesh Gradient) */
        .magic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: 200% 200%;
            animation: gradient-flow 15s ease infinite;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float-orb 10s infinite alternate;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: #7c3aed;
            top: -100px;
            left: -100px;
        }

        .orb-2 {
            width: 500px;
            height: 500px;
            background: #db2777;
            bottom: -100px;
            right: -100px;
            animation-delay: -5s;
        }

        .orb-3 {
            width: 300px;
            height: 300px;
            background: #2563eb;
            top: 40%;
            left: 40%;
            animation-duration: 20s;
        }

        @@keyframes gradient-flow {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @@keyframes float-orb {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(50px, 50px);
            }
        }

        /* --- 2. LAYOUT MAIN STAGE --- */
        .app-layout {
            display: flex;
            height: calc(100vh - 64px); /* Trừ header */
            width: 100%;
            justify-content: center; /* Căn giữa */
            padding: 16px; /* Khoảng cách lề */
        }

        /* Khung chat chính (Dạng Card nổi) */
        .main-stage {
            width: 100%;
            max-width: 1200px; /* Giới hạn chiều rộng để dễ nhìn trên màn to */
            position: relative;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px; /* Bo tròn đều 4 góc */
            box-shadow: 0 20px 50px -12px rgba(0,0,0,0.25);
            border: 1px solid rgba(255, 255, 255, 0.5);
            overflow: hidden;
        }

        /* --- 3. WELCOME HERO --- */
        .hero-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            overflow-y: auto;
        }

        .magic-title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(to right, #7c3aed, #db2777, #2563eb);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            letter-spacing: -1px;
            line-height: 1.2;
        }

        .magic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            max-width: 900px;
            width: 100%;
            margin-top: 40px;
        }

        .template-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            text-align: left;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

            .template-card:hover {
                transform: translateY(-5px) scale(1.02);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                border-color: #d8b4fe;
            }

        .icon-box {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            font-size: 20px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #f3e8ff, #fce7f3);
            color: #9333ea;
        }

        .tpl-title {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .tpl-desc {
            font-size: 13px;
            color: #64748b;
        }

        /* --- 4. CHAT STREAM --- */
        .chat-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px 10%; /* Padding rộng để nội dung tập trung */
            scroll-behavior: smooth;
        }

        .msg-block {
            margin-bottom: 40px;
            animation: slideUp 0.4s ease;
        }

        @@keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-request {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 15px;
        }

        .user-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            text-align: right;
            background: linear-gradient(90deg, #1e293b, #475569);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* --- 5. RESULT GALLERY --- */
        .ai-response {
            margin-top: 20px;
        }

        .ai-insight {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #f0fdf4;
            color: #166534;
            padding: 8px 16px;
            border-radius: 99px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
            border: 1px solid #bbf7d0;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            width: 100%;
        }

        .design-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            border: 1px solid #f1f5f9;
            position: relative;
        }

            .design-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            }

        .card-img-wrap {
            height: 160px;
            background: #f8fafc;
            position: relative;
            display: grid;
            place-items: center;
            padding: 10px;
        }

        .card-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .card-info {
            padding: 12px;
        }

        .card-price {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }

        .overlay-actions {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .design-card:hover .overlay-actions {
            opacity: 1;
        }

        .btn-use {
            background: #7c3aed;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: 0.2s;
        }

            .btn-use:hover {
                background: #6d28d9;
                transform: scale(1.05);
            }

        /* --- 6. FLOATING INPUT --- */
        .input-dock {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }

        .magic-input-bar {
            pointer-events: auto;
            width: 600px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 99px;
            padding: 8px 8px 8px 24px;
            display: flex;
            align-items: center;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15);
            transition: width 0.3s;
        }

            .magic-input-bar:focus-within {
                width: 700px;
                background: white;
                border-color: #d8b4fe;
            }

        .magic-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 16px;
            color: #1e293b;
        }

        .btn-magic-send {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed, #db2777);
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: transform 0.2s;
        }

            .btn-magic-send:hover {
                transform: rotate(15deg) scale(1.1);
            }

        /* Mobile */
        @@media(max-width: 768px) {
            .app-layout {
                padding: 0;
                height: calc(100vh - 56px);
            }

            .main-stage {
                border-radius: 0;
                border: none;
            }

            .magic-input-bar {
                width: 90%;
            }

            .chat-scroll-area {
                padding: 20px 5%;
            }

            .user-text {
                font-size: 1.1rem;
            }

            .magic-title {
                font-size: 2rem;
            }
        }
    </style>
}

<div class="magic-bg">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
</div>

<div class="app-layout">
    <main class="main-stage">

        <button onclick="location.reload()" class="absolute top-4 left-4 z-20 w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 grid place-items-center transition-colors shadow-sm" title="Cuộc trò chuyện mới">
            <i class="fa-solid fa-rotate-right"></i>
        </button>

        <div id="scroll-container" class="chat-scroll-area">

            <div id="hero-view" class="hero-center">
                <div class="mb-6 inline-flex p-3 rounded-2xl bg-white shadow-lg shadow-purple-500/20">
                    <i class="fa-solid fa-wand-magic-sparkles text-3xl text-purple-600"></i>
                </div>
                <h1 class="magic-title">Bạn muốn tìm xe gì hôm nay?</h1>
                <p class="text-slate-500 text-lg mb-8 max-w-xl">
                    Hãy mô tả nhu cầu, tôi sẽ tạo ra một "bộ sưu tập" xe phù hợp nhất dành riêng cho bạn.
                </p>

                <div class="magic-grid">
                    <div class="template-card" onclick="usePrompt('Tìm xe tay ga cho nữ văn phòng, tài chính 40 triệu')">
                        <div class="icon-box"><i class="fa-solid fa-person-dress"></i></div>
                        <div class="tpl-title">Xe tay ga nữ</div>
                        <div class="tpl-desc">Thanh lịch, cốp rộng, tầm 40 triệu</div>
                    </div>
                    <div class="template-card" onclick="usePrompt('Nam 1m75, thích đi phượt, xe côn tay máy khỏe')">
                        <div class="icon-box"><i class="fa-solid fa-motorcycle"></i></div>
                        <div class="tpl-title">Nam tính & Tốc độ</div>
                        <div class="tpl-desc">Xe côn tay, đi phượt, động cơ mạnh</div>
                    </div>
                    <div class="template-card" onclick="usePrompt('Sinh viên cần xe bền, tiết kiệm xăng để đi học')">
                        <div class="icon-box"><i class="fa-solid fa-graduation-cap"></i></div>
                        <div class="tpl-title">Sinh viên tiết kiệm</div>
                        <div class="tpl-desc">Bền bỉ, ít hỏng vặt, tiết kiệm xăng</div>
                    </div>
                    <div class="template-card" onclick="usePrompt('So sánh chi tiết Honda Vision và Yamaha Janus')">
                        <div class="icon-box"><i class="fa-solid fa-scale-balanced"></i></div>
                        <div class="tpl-title">So sánh xe</div>
                        <div class="tpl-desc">Phân tích ưu nhược điểm các dòng</div>
                    </div>
                </div>
            </div>

            <div id="chat-content"></div>

            <div id="loading-spinner" class="hidden py-10 text-center">
                <div class="inline-block relative w-20 h-20">
                    <div class="absolute top-0 left-0 w-full h-full border-4 border-purple-200 rounded-full opacity-50"></div>
                    <div class="absolute top-0 left-0 w-full h-full border-4 border-t-purple-600 rounded-full animate-spin"></div>
                    <i class="fa-solid fa-wand-magic-sparkles absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-purple-600"></i>
                </div>
                <p class="text-slate-400 mt-4 text-sm font-medium animate-pulse">Đang thiết kế bộ sưu tập...</p>
            </div>

            <div class="h-24"></div>
        </div>

        <div class="input-dock">
            <div class="magic-input-bar">
                <i class="fa-solid fa-magnifying-glass text-slate-400 ml-2 mr-3"></i>
                <input id="ai-input" type="text" class="magic-input" placeholder="Mô tả chiếc xe mơ ước của bạn..." autocomplete="off">
                <button id="ai-send" class="btn-magic-send">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>
    </main>
</div>

@section Scripts {
    <script>
        const ui = {
            input: document.getElementById('ai-input'),
            sendBtn: document.getElementById('ai-send'),
            hero: document.getElementById('hero-view'),
            chat: document.getElementById('chat-content'),
            scroll: document.getElementById('scroll-container'),
            loader: document.getElementById('loading-spinner')
        };

        let currentConversationId = null;

        // === LOGIC GỬI TIN NHẮN ===
        async function sendMessage() {
            const txt = ui.input.value.trim();
            if(!txt) return;

            // 1. UI Transition
            ui.hero.style.display = 'none'; // Ẩn màn hình chào
            ui.input.value = '';

            // Append User Question
            const userDiv = document.createElement('div');
            userDiv.className = 'msg-block user-request';
            userDiv.innerHTML = `<div class="user-text">${txt}</div><div class="w-10 h-10 rounded-full bg-slate-200 grid place-items-center text-slate-500"><i class="fa-solid fa-user"></i></div>`;
            ui.chat.appendChild(userDiv);

            ui.loader.classList.remove('hidden'); // Show loading
            scrollToBottom();

            // 2. Call API
            try {
                const res = await fetch('/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: txt, conversationId: currentConversationId })
                });
                const data = await res.json();
                if(data.conversationId) currentConversationId = data.conversationId;

                // 3. Render AI Response
                ui.loader.classList.add('hidden');

                const botDiv = document.createElement('div');
                botDiv.className = 'msg-block ai-response';

                // Insight
                let html = ``;
                if(data.insight) {
                    html += `<div class="ai-insight"><i class="fa-solid fa-lightbulb"></i> AI Hiểu: ${data.insight}</div>`;
                }

                // Grid Gallery
                if(data.items && data.items.length > 0) {
                    html += `<div class="gallery-grid">`;
                    data.items.forEach(p => {
                        html += `
                        <div class="design-card group">
                            <div class="card-price">${(p.price || 0).toLocaleString('vi-VN')}₫</div>
                            <div class="card-img-wrap">
                                <img src="${p.imageUrl || '/images/default-moto.png'}" class="card-img" alt="${p.name}">
                            </div>
                            <div class="card-info">
                                <div class="text-[10px] font-bold text-purple-600 uppercase mb-1">${p.brand || 'XE MÁY'}</div>
                                <div class="font-bold text-slate-800 text-sm mb-2 line-clamp-1" title="${p.name}">${p.name}</div>
                                <div class="text-xs text-slate-500 bg-slate-50 p-2 rounded">${p.reason}</div>
                            </div>
                            <div class="overlay-actions">
                                <a href="/products/${p.productId}" class="btn-use">
                                    Xem chi tiết <i class="fa-solid fa-arrow-right ml-1"></i>
                                </a>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="p-6 bg-slate-50 rounded-xl text-center text-slate-500">Không tìm thấy xe phù hợp. Thử lại với ngân sách khác nhé!</div>`;
                }

                botDiv.innerHTML = html;
                ui.chat.appendChild(botDiv);
                scrollToBottom();

            } catch (err) {
                console.error(err);
                ui.loader.classList.add('hidden');
            }
        }

        function scrollToBottom() {
            ui.scroll.scrollTop = ui.scroll.scrollHeight;
        }

        window.usePrompt = (t) => {
            ui.input.value = t;
            sendMessage();
        }

        ui.sendBtn.addEventListener('click', sendMessage);
        ui.input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') sendMessage();
        });

        document.addEventListener("DOMContentLoaded", () => {
            const p = new URLSearchParams(window.location.search);
            const q = p.get('q');
            if(q) {
                ui.input.value = q;
                sendMessage();
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
}