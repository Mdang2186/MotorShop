@model MotorShop.ViewModels.ProductDetailViewModel
@using System.Globalization

@{
    ViewData["Title"] = Model.Product?.Name ?? "Chi tiết sản phẩm";

    var p = Model.Product!;
    string Price(decimal x) => string.Format(CultureInfo.GetCultureInfo("vi-VN"), "{0:N0} ₫", x);

    decimal price = p.Price;
    decimal? original = p.OriginalPrice;
    bool hasSale = original.HasValue && original.Value > price;
    var discount = hasSale ? Math.Round((1 - (price / original.Value)) * 100) : 0;

    var imgs = (p.Images?.OrderBy(i => i.SortOrder).ToList() ?? new List<MotorShop.Models.ProductImage>());
    var mainImg = !string.IsNullOrWhiteSpace(p.ImageUrl)
        ? p.ImageUrl
        : imgs.FirstOrDefault()?.ImageUrl ?? "~/images/placeholders/product.webp";
}

<style>
    /* chỉ dành cho trang này */
    .pd-thumb {
        transition: all .2s ease;
    }

        .pd-thumb.is-active {
            outline: 2px solid rgba(37,99,235,1);
            outline-offset: 0;
            box-shadow: 0 10px 25px rgba(37,99,235,.12);
        }

    .pd-main-img {
        transition: transform .35s ease;
    }

        .pd-main-img:hover {
            transform: scale(1.01);
        }

    .badge-dot {
        width: 6px;
        height: 6px;
        border-radius: 9999px;
    }
</style>

<!-- BREADCRUMB + HERO NHỎ ========================================= -->
<section class="relative overflow-hidden bg-gradient-to-r from-slate-50 via-white to-slate-50 border-b border-slate-100 mb-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex flex-wrap items-center justify-between gap-4">
        <nav class="text-sm text-slate-500 flex flex-wrap items-center gap-2">
            <a asp-controller="Home" asp-action="Index" class="hover:text-slate-800 flex items-center gap-1">
                <i class="fa-solid fa-house text-xs"></i> Trang chủ
            </a>
            <span>/</span>
            <a asp-controller="Products" asp-action="Index" class="hover:text-slate-800">Sản phẩm</a>
            @if (p.Category != null)
            {
                <span>/</span>
                <a asp-controller="Products" asp-action="Index" asp-route-categoryFilter="@p.CategoryId" class="hover:text-slate-800">
                    @p.Category.Name
                </a>
            }
            <span>/</span>
            <span class="text-slate-900 font-medium">@p.Name</span>
        </nav>

        <div class="flex gap-2 text-xs">
            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">
                <span class="badge-dot bg-emerald-500"></span> Giao xe nhanh
            </span>
            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                <i class="fa-regular fa-shield"></i> Bảo hành chính hãng
            </span>
        </div>
    </div>
</section>

<!-- MAIN ========================================================= -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 lg:gap-12 items-start">

        <!-- LEFT: IMAGE + THUMBNAIL -->
        <div class="grid grid-cols-5 gap-4">
            <!-- thumbnails (dọc) -->
            <div class="flex lg:flex-col gap-3 col-span-5 lg:col-span-1 order-2 lg:order-1">
                @if (imgs.Count > 0)
                {
                    @for (int i = 0; i < imgs.Count; i++)
                    {
                        var im = imgs[i];
                        <button type="button"
                                class="pd-thumb group w-16 h-16 lg:w-20 lg:h-20 bg-white border border-slate-100 rounded-xl overflow-hidden hover:shadow-sm hover:scale-[1.02] transition"
                                data-img="@Url.Content(im.ImageUrl)" @(i == 0 && string.IsNullOrWhiteSpace(p.ImageUrl) ? "data-active='true'" : "")>
                            <img src="@Url.Content(im.ImageUrl)" alt="@im.Caption" class="w-full h-full object-cover" />
                        </button>
                    }
                }
                else
                {
                    <div class="w-16 h-16 lg:w-20 lg:h-20 bg-slate-100 rounded-xl grid place-items-center text-slate-400 text-xs">
                        No img
                    </div>
                }
            </div>

            <!-- main image -->
            <div class="col-span-5 lg:col-span-4 order-1 lg:order-2">
                <div class="relative rounded-2xl bg-white border border-slate-100 shadow-sm overflow-hidden min-h-[320px] lg:min-h-[420px]">
                    <img id="mainImg"
                         src="@(Url.Content(mainImg))"
                         alt="@p.Name"
                         class="pd-main-img w-full h-full object-contain bg-[radial-gradient(circle_at_top,_#eef2ff_0,_#fff_55%)]" />
                    @if (hasSale)
                    {
                        <div class="absolute top-4 left-4 px-3 py-1.5 rounded-full bg-rose-500 text-white text-xs font-semibold shadow-sm flex items-center gap-1">
                            <i class="fa-solid fa-fire-flame-curved text-[11px]"></i>
                            Giảm @discount%
                        </div>
                    }
                    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 bg-slate-950/10 backdrop-blur-sm px-3 py-1.5 rounded-full text-xs text-slate-700">
                        <span class="flex items-center gap-1"><i class="fa-regular fa-image"></i> @((imgs?.Count ?? 0) + 1) ảnh</span>
                        <span class="w-px bg-slate-300/60"></span>
                        <span class="flex items-center gap-1"><i class="fa-regular fa-eye"></i> Xoay để xem chi tiết</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: INFO CARD -->
        <div class="space-y-6">
            <!-- Title -->
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-6">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900 leading-tight">@p.Name</h1>
                        <div class="mt-2 flex flex-wrap gap-3 text-sm text-slate-500">
                            @if (p.Brand != null)
                            {
                                <span>
                                    Hãng:
                                    <a asp-controller="Products" asp-action="Index" asp-route-brandFilter="@p.BrandId"
                                       class="text-blue-600 hover:underline font-medium">@p.Brand.Name</a>
                                </span>
                            }
                            @if (p.Category != null)
                            {
                                <span class="text-slate-300">•</span>
                                <span>
                                    Loại:
                                    <a asp-controller="Products" asp-action="Index" asp-route-categoryFilter="@p.CategoryId"
                                       class="text-blue-600 hover:underline font-medium">@p.Category.Name</a>
                                </span>
                            }
                            <span class="text-slate-300">•</span>
                            <span>Mã SP: #@p.Id</span>
                        </div>
                    </div>
                    <div class="text-right space-y-1">
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-50 text-slate-500 text-[10px] uppercase tracking-[.2em]">
                            MotorShop
                        </span>
                        <div class="text-xs text-slate-400">Cập nhật @DateTime.Now.ToString("dd/MM/yyyy")</div>
                    </div>
                </div>

                <!-- Giá -->
                <div class="mt-5">
                    @if (hasSale)
                    {
                        <div class="flex flex-wrap items-baseline gap-3">
                            <div class="text-3xl font-extrabold text-slate-900">@Price(price)</div>
                            <div class="text-lg line-through text-slate-400">@Price(original!.Value)</div>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-rose-50 text-rose-600 text-xs font-semibold">
                                Tiết kiệm @discount%
                            </span>
                        </div>
                    }
                    else
                    {
                        <div class="text-3xl font-extrabold text-slate-900">@Price(price)</div>
                    }
                    <p class="mt-2 text-xs text-slate-500">
                        Giá bao gồm VAT. Hỗ trợ trả góp 0% với ngân hàng đối tác.
                    </p>
                </div>

                <!-- Stock -->
                <div class="mt-4 flex flex-wrap gap-3">
                    @if (p.StockQuantity > 0)
                    {
                        <div class="inline-flex items-center gap-2 text-emerald-700 bg-emerald-50 border border-emerald-100 px-3 py-1.5 rounded-xl text-sm">
                            <i class="fa-regular fa-circle-check"></i> Còn hàng (@p.StockQuantity)
                        </div>
                    }
                    else
                    {
                        <div class="inline-flex items-center gap-2 text-amber-700 bg-amber-50 border border-amber-100 px-3 py-1.5 rounded-xl text-sm">
                            <i class="fa-regular fa-clock"></i> Tạm hết – đặt trước
                        </div>
                    }
                    <div class="inline-flex items-center gap-2 text-slate-500 text-sm">
                        <i class="fa-solid fa-truck-fast text-slate-400"></i> Giao xe toàn quốc
                    </div>
                </div>

                <!-- Action -->
                <div class="mt-6 flex flex-wrap items-center gap-4">
                    <div class="flex items-center border border-slate-200 rounded-xl overflow-hidden">
                        <button type="button" class="px-3 py-2 text-slate-600 hover:bg-slate-50"
                                onclick="const q=document.getElementById('qty'); q.value=Math.max(1, (+q.value||1)-1);">
                            −
                        </button>
                        <input id="qty" value="1" inputmode="numeric" class="w-14 text-center outline-none py-2 text-slate-900" />
                        <button type="button" class="px-3 py-2 text-slate-600 hover:bg-slate-50"
                                onclick="const q=document.getElementById('qty'); q.value=Math.min(100, (+q.value||1)+1);">
                            +
                        </button>
                    </div>

                    <button id="btnAddToCart"
                            class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl font-semibold shadow-sm transition">
                        <i class="fa-solid fa-cart-plus"></i> Thêm vào giỏ
                    </button>

                    <a asp-controller="Cart" asp-action="Index"
                       class="inline-flex items-center gap-2 text-slate-700 border border-slate-200 px-5 py-2.5 rounded-xl font-semibold hover:bg-slate-50">
                        <i class="fa-solid fa-bag-shopping"></i> Xem giỏ
                    </a>
                </div>

                <!-- hotline -->
                <div class="mt-6 flex items-center gap-3 p-3 rounded-2xl bg-slate-50 border border-slate-100">
                    <div class="w-10 h-10 rounded-2xl bg-blue-600 text-white grid place-items-center">
                        <i class="fa-solid fa-headset text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">Cần tư vấn về phiên bản / màu / trả góp?</p>
                        <p class="text-sm font-semibold text-slate-900">Hotline: 1900 1234 (08:30 – 20:30)</p>
                    </div>
                </div>
            </div>

            <!-- info nhỏ -->
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-white rounded-xl border border-slate-100 p-4 flex gap-3 items-start">
                    <div class="w-9 h-9 rounded-xl bg-blue-50 text-blue-600 grid place-items-center">
                        <i class="fa-solid fa-credit-card"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-900">Trả góp 0%</p>
                        <p class="text-xs text-slate-400">Qua thẻ Visa, Mastercard</p>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-slate-100 p-4 flex gap-3 items-start">
                    <div class="w-9 h-9 rounded-xl bg-emerald-50 text-emerald-600 grid place-items-center">
                        <i class="fa-solid fa-shield-halved"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-900">Bảo hành 12T</p>
                        <p class="text-xs text-slate-400">Tại TTBH chính hãng</p>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-slate-100 p-4 flex gap-3 items-start">
                    <div class="w-9 h-9 rounded-xl bg-amber-50 text-amber-500 grid place-items-center">
                        <i class="fa-solid fa-location-dot"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-900">Nhận tại showroom</p>
                        <p class="text-xs text-slate-400">Hà Nội / HCM</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- SPEC ====================================================== -->
    @if (p.Specifications?.Any() == true)
    {
        <div class="mt-12 bg-white rounded-2xl border border-slate-100 shadow-sm">
            <div class="flex items-center justify-between px-6 pt-6 pb-2">
                <h2 class="text-lg md:text-xl font-bold text-slate-900">Thông số kỹ thuật</h2>
                <span class="text-xs text-slate-400 uppercase tracking-[.25em]">specs</span>
            </div>
            <div class="p-6 overflow-x-auto">
                <table class="min-w-full text-sm">
                    <tbody class="divide-y divide-slate-100">
                        @foreach (var s in p.Specifications.OrderBy(x => x.SortOrder))
                        {
                            <tr>
                                <td class="py-3 pr-6 text-slate-500 w-1/4 min-w-[190px]">@s.Name</td>
                                <td class="py-3 text-slate-900 font-medium">@s.Value</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <!-- RELATED =================================================== -->
    @if (Model.RelatedProducts?.Any() == true)
    {
        <div class="mt-12">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg md:text-xl font-bold text-slate-900">Có thể bạn cũng thích</h2>
                <a asp-controller="Products" asp-action="Index" asp-route-categoryFilter="@p.CategoryId"
                   class="text-sm text-blue-600 hover:text-blue-700 inline-flex items-center gap-1">
                    Xem tất cả <i class="fa-solid fa-arrow-right-long text-xs"></i>
                </a>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
                @foreach (var r in Model.RelatedProducts)
                {
                    <partial name="_ProductCardPartial" model="r" />
                }
            </div>
        </div>
    }
</section>

@section Scripts {
    <script>
        // kích hoạt thumbnail
        document.querySelectorAll('.pd-thumb').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.pd-thumb').forEach(x => x.classList.remove('is-active'));
                btn.classList.add('is-active');
                const src = btn.getAttribute('data-img');
                if (src) {
                    document.getElementById('mainImg').src = src;
                }
            });
        });
        // đánh dấu cái đầu
        const firstThumb = document.querySelector('.pd-thumb');
        if (firstThumb) firstThumb.classList.add('is-active');

        const getCsrf = window.getCsrf ? window.getCsrf : () => '';
        const toast = typeof showToast === "function" ? showToast : (m) => alert(m);

        document.getElementById('btnAddToCart')?.addEventListener('click', async () => {
            const qtyEl = document.getElementById('qty');
            const qty = Math.max(1, Math.min(100, parseInt(qtyEl.value || '1', 10)));

            try {
                const res = await fetch('@Url.Action("AddToCart", "Cart")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getCsrf()
                    },
                    body: JSON.stringify({ productId: @p.Id, quantity: qty })
                });
                const data = await res.json().catch(() => ({}));
                if (res.ok && data?.success) {
                    toast(data.message || 'Đã thêm vào giỏ.', 'success');
                    if (typeof window.refreshCartBadge === 'function') window.refreshCartBadge();
                } else {
                    toast(data?.message || 'Không thể thêm vào giỏ.', 'error');
                }
            } catch {
                toast('Lỗi kết nối. Thử lại sau.', 'error');
            }
        });
    </script>
}
