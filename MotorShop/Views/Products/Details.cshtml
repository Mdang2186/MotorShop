@model MotorShop.ViewModels.ProductDetailViewModel
@using System.Globalization

@{
    ViewData["Title"] = Model.Product?.Name ?? "Chi tiết sản phẩm";
    var p = Model.Product!;

    // --- FORMATTERS ---
    string FormatPrice(decimal x) => string.Format(CultureInfo.GetCultureInfo("vi-VN"), "{0:N0} ₫", x);

    // --- LOGIC GIÁ & KHUYẾN MÃI ---
    decimal price = p.Price;
    decimal? original = p.OriginalPrice;
    bool hasSale = original.HasValue && original.Value > price;
    int discountPercent = hasSale ? (int)Math.Round((1 - (price / original!.Value)) * 100) : 0;
    bool inStock = p.StockQuantity > 0;

    // --- HÌNH ẢNH ---
    var imgs = p.Images?.OrderBy(i => i.SortOrder).ToList() ?? new List<MotorShop.Models.ProductImage>();
    var mainImgUrl = !string.IsNullOrWhiteSpace(p.ImageUrl) ? p.ImageUrl : (imgs.FirstOrDefault()?.ImageUrl ?? "/images/placeholders/product.webp");

    // --- LOGO THƯƠNG HIỆU ---
    string brandSlug = p.Brand?.Name.ToLower().Replace(" ", "-").Replace(".", "") ?? "default";
    string brandLogoUrl = $"/images/brands/{brandSlug}.png";

    // =================================================================================
    // --- 1. LOGIC CHI NHÁNH & KHO HÀNG (FIX LỖI "PHỐ HUẾ" NHẬN NHẦM MIỀN TRUNG) ---
    // =================================================================================
    var allBranches = Model.Branches ?? new List<MotorShop.Models.Branch>();

    // MIỀN BẮC
    var branchesNorth = allBranches.Where(b =>
        b.Address.Contains("Hà Nội", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Hải Phòng", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Quảng Ninh", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Bắc Ninh", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Hưng Yên", StringComparison.OrdinalIgnoreCase)
    ).ToList();

    // MIỀN TRUNG
    // Đã sửa: Bỏ "Huế" đơn độc (tránh Phố Huế), dùng "Thừa Thiên Huế" hoặc "TP.Huế"
    var branchesCentral = allBranches.Where(b =>
        b.Address.Contains("Đà Nẵng", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Thừa Thiên Huế", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("TP. Huế", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Nghệ An", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Thanh Hóa", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Khánh Hòa", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Nha Trang", StringComparison.OrdinalIgnoreCase)
    ).ToList();

    // MIỀN NAM
    var branchesSouth = allBranches.Where(b =>
        b.Address.Contains("Hồ Chí Minh", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("TP.HCM", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Cần Thơ", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Bình Dương", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Đồng Nai", StringComparison.OrdinalIgnoreCase) ||
        b.Address.Contains("Vũng Tàu", StringComparison.OrdinalIgnoreCase)
    ).ToList();

    // =================================================================================
    // --- 2. LOGIC XỬ LÝ DỮ LIỆU NGẮN GỌN (SMART SPECS) ---
    // =================================================================================

    // Động cơ / Công suất
    string spec_EngineLabel = "Động cơ";
    string spec_EngineValue = "Tiêu chuẩn";

    var findCC = p.Specifications.FirstOrDefault(s => s.Name.Contains("xy-lanh", StringComparison.OrdinalIgnoreCase) || s.Name.Contains("xi-lanh", StringComparison.OrdinalIgnoreCase));
    var findPower = p.Specifications.FirstOrDefault(s => s.Name.Contains("Công suất", StringComparison.OrdinalIgnoreCase));

    if (findCC != null && !string.IsNullOrEmpty(findCC.Value))
    {
        spec_EngineValue = findCC.Value.Replace("cm³", "cc").Replace("approximately", "").Trim();
    }
    else if (findPower != null && !string.IsNullOrEmpty(findPower.Value))
    {
        spec_EngineLabel = "Công suất";
        spec_EngineValue = findPower.Value.Split(',')[0].Split('(')[0].Trim();
    }

    // Trọng lượng
    string spec_WeightValue = "-";
    var findWeight = p.Specifications.FirstOrDefault(s => s.Name.Contains("Trọng lượng", StringComparison.OrdinalIgnoreCase) || s.Name.Contains("Khối lượng", StringComparison.OrdinalIgnoreCase));
    if (findWeight != null && !string.IsNullOrEmpty(findWeight.Value))
    {
        spec_WeightValue = findWeight.Value.Split('(')[0].Trim();
    }
}

<link rel="stylesheet" href="~/css/productdetails.css" />
@Html.AntiForgeryToken()

<div id="sticky-nav" class="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-md border-b border-slate-200 transform -translate-y-full transition-transform duration-300 shadow-sm">
    <div class="max-w-[1200px] mx-auto px-4 h-16 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-lg border border-slate-100 bg-white p-0.5 overflow-hidden">
                <img src="@Url.Content(mainImgUrl)" class="w-full h-full object-contain" />
            </div>
            <div>
                <h2 class="text-sm font-bold text-slate-900 line-clamp-1 max-w-[300px]">@p.Name</h2>
                <div class="text-xs text-[#FD4057] font-bold">@FormatPrice(price)</div>
            </div>
            <div class="hidden md:flex gap-1 ml-6 border-l border-slate-200 pl-6">
                <a href="#tong-quan" class="px-3 py-1.5 text-xs font-semibold text-slate-600 hover:text-[#00D1E4] hover:bg-slate-50 rounded-full transition">Tổng quan</a>
                <a href="#thong-so" class="px-3 py-1.5 text-xs font-semibold text-slate-600 hover:text-[#00D1E4] hover:bg-slate-50 rounded-full transition">Thông số</a>
                <a href="#bai-viet" class="px-3 py-1.5 text-xs font-semibold text-slate-600 hover:text-[#00D1E4] hover:bg-slate-50 rounded-full transition">Đánh giá</a>
            </div>
        </div>
        <div class="flex items-center gap-3">
            @if (inStock)
            {
                <button onclick="handleBuyAction('@p.Id', true)" class="bg-gradient-to-r from-[#00D1E4] to-[#00b8c9] hover:shadow-lg text-white text-xs font-bold px-6 py-2.5 rounded-xl transition transform active:scale-95 shadow-cyan-200/50">
                    Mua ngay
                </button>
            }
        </div>
    </div>
</div>

<div class="bg-[#F8F9FA] min-h-screen font-sans text-slate-800 pb-20 pt-6">

    <div class="max-w-[1200px] mx-auto px-4 mb-6">
        <nav class="flex text-xs font-medium text-slate-500">
            <ol class="inline-flex items-center space-x-1 md:space-x-2">
                <li><a href="/" class="hover:text-[#00D1E4] transition">Trang chủ</a></li>
                <li><i class="fa-solid fa-angle-right text-[10px] text-slate-300"></i></li>
                <li><a href="/products" class="hover:text-[#00D1E4] transition">Sản phẩm</a></li>
                @if (p.Category != null)
                {
                    <li><i class="fa-solid fa-angle-right text-[10px] text-slate-300"></i></li>
                    <li><a href="/products?categoryFilter=@p.CategoryId" class="hover:text-[#00D1E4] transition">@p.Category.Name</a></li>
                }
                <li><i class="fa-solid fa-angle-right text-[10px] text-slate-300"></i></li>
                <li class="text-slate-900 font-semibold truncate max-w-[200px]">@p.Name</li>
            </ol>
        </nav>
    </div>

    <div class="max-w-[1200px] mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <div class="lg:col-span-8 space-y-6">

                <div id="tong-quan" class="bg-white rounded-2xl p-2 shadow-sm border border-slate-100 overflow-hidden">
                    <div class="relative group bg-[#F9FAFB] rounded-xl overflow-hidden aspect-[16/10] flex items-center justify-center cursor-zoom-in">
                        <img id="mainImg" src="@Url.Content(mainImgUrl)" class="max-w-[90%] max-h-[90%] object-contain transition-transform duration-500 group-hover:scale-105" alt="@p.Name" />
                        @if (hasSale)
                        {
                            <span class="absolute top-4 left-4 bg-[#FD4057] text-white text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm">-@discountPercent%</span>
                        }
                    </div>

                    @if (imgs.Count > 0)
                    {
                        <div class="px-4 pb-4 mt-4">
                            <div class="flex gap-3 overflow-x-auto scrollbar-hide py-1 justify-center">
                                <div class="pd-thumb-btn active w-16 h-16 rounded-xl border-2 border-transparent bg-slate-50 p-1 cursor-pointer hover:border-[#00D1E4] transition shrink-0"
                                     data-img="@Url.Content(!string.IsNullOrEmpty(p.ImageUrl) ? p.ImageUrl : "/images/placeholders/product.webp")">
                                    <img src="@Url.Content(!string.IsNullOrEmpty(p.ImageUrl) ? p.ImageUrl : "/images/placeholders/product.webp")" class="w-full h-full object-contain" />
                                </div>
                                @foreach (var img in imgs)
                                {
                                    <div class="pd-thumb-btn w-16 h-16 rounded-xl border-2 border-transparent bg-slate-50 p-1 cursor-pointer hover:border-[#00D1E4] transition shrink-0"
                                         data-img="@Url.Content(img.ImageUrl)">
                                        <img src="@Url.Content(img.ImageUrl)" class="w-full h-full object-contain" />
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 text-center hover:border-[#00D1E4] transition group">
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1 block group-hover:text-[#00D1E4]">Sản xuất</span>
                        <span class="text-lg font-extrabold text-slate-900">@p.Year</span>
                    </div>
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 text-center hover:border-[#00D1E4] transition group">
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1 block group-hover:text-[#00D1E4]">@spec_EngineLabel</span>
                        <span class="text-lg font-extrabold text-slate-900 truncate block px-2" title="@spec_EngineValue">@spec_EngineValue</span>
                    </div>
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 text-center hover:border-[#00D1E4] transition group">
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1 block group-hover:text-[#00D1E4]">Trọng lượng</span>
                        <span class="text-lg font-extrabold text-slate-900 truncate block px-2">@spec_WeightValue</span>
                    </div>
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 text-center hover:border-[#00D1E4] transition group">
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1 block group-hover:text-[#00D1E4]">Bảo hành</span>
                        <span class="text-lg font-extrabold text-slate-900">3 Năm</span>
                    </div>
                </div>

                <div id="bai-viet" class="bg-white rounded-2xl p-6 md:p-8 shadow-sm border border-slate-100 scroll-mt-24">
                    <div class="flex items-center gap-3 mb-8">
                        <span class="w-1.5 h-8 bg-[#00D1E4] rounded-full"></span>
                        <h2 class="text-2xl font-extrabold text-slate-900 uppercase tracking-tight">Đánh giá chi tiết</h2>
                    </div>

                    <div id="descriptionContent" class="group/desc relative overflow-hidden transition-all duration-700 ease-in-out" style="max-height: 600px;">
                        <div class="prose prose-slate max-w-none prose-lg prose-p:text-justify prose-p:text-slate-600 prose-headings:font-bold prose-headings:text-slate-900 prose-a:text-[#00D1E4] prose-img:rounded-2xl prose-img:shadow-lg prose-img:w-full prose-img:border prose-img:border-slate-100">
                            @{
                                var rawDesc = p.Description ?? "";
                                var gallery = p.Images?.Where(i => !i.IsPrimary).OrderBy(i => i.SortOrder).ToList() ?? new List<MotorShop.Models.ProductImage>();
                                var paragraphs = rawDesc.Split(new[] { "</p>" }, StringSplitOptions.RemoveEmptyEntries);
                                int imgIdx = 0;
                            }

                            @if (paragraphs.Length > 0)
                            {
                                for (int i = 0; i < paragraphs.Length; i++)
                                {
                                    @Html.Raw(paragraphs[i] + "</p>")
                                    if ((i + 1) % 2 == 0 && imgIdx < gallery.Count)
                                    {
                                        var img = gallery[imgIdx];
                                        <figure class="my-10">
                                            <img src="@Url.Content(img.ImageUrl)" alt="@p.Name - Chi tiết" loading="lazy" />
                                            <figcaption class="text-center text-sm text-slate-500 italic mt-3 flex items-center justify-center gap-1">
                                                <i class="fa-solid fa-camera text-slate-300"></i>
                                                @(string.IsNullOrEmpty(img.Caption) ? $"Góc nhìn chi tiết {imgIdx + 1}" : img.Caption)
                                            </figcaption>
                                        </figure>
                                        imgIdx++;
                                    }
                                }
                            }
                            else
                            {
                                @Html.Raw(rawDesc)
                            }

                            @if (imgIdx < gallery.Count)
                            {
                                <div class="not-prose mt-12">
                                    <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                                        <i class="fa-regular fa-images text-[#00D1E4]"></i> Thư viện ảnh thực tế
                                    </h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        @for (int j = imgIdx; j < gallery.Count; j++)
                                        {
                                            <div class="rounded-xl overflow-hidden border border-slate-100 shadow-sm group relative cursor-zoom-in">
                                                <img src="@Url.Content(gallery[j].ImageUrl)" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy" />
                                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors pointer-events-none"></div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <div class="not-prose mt-12 mb-6">
                                <div class="bg-slate-50 rounded-2xl p-6 border border-slate-200 relative overflow-hidden">
                                    <div class="absolute top-0 right-0 p-6 opacity-10">
                                        <i class="fa-solid fa-quote-right text-6xl text-slate-400"></i>
                                    </div>
                                    <h3 class="text-lg font-extrabold text-slate-900 mb-3 flex items-center gap-2">
                                        <span class="w-8 h-8 rounded-full bg-[#00D1E4] text-white flex items-center justify-center text-xs">
                                            <i class="fa-solid fa-check"></i>
                                        </span>
                                        Tổng kết nhanh
                                    </h3>
                                    <p class="text-slate-600 text-sm leading-relaxed mb-4 text-justify">
                                        Nhìn chung, <strong>@p.Name</strong> là một lựa chọn sáng giá trong phân khúc <strong>@(p.Category?.Name ?? "xe máy")</strong>.
                                        Với thiết kế hiện đại, động cơ <strong>@spec_EngineValue</strong> mạnh mẽ và trọng lượng <strong>@spec_WeightValue</strong> hợp lý,
                                        đây là mẫu xe đáng cân nhắc cho nhu cầu di chuyển hàng ngày cũng như những chuyến đi xa.
                                    </p>
                                </div>
                            </div>

                            @if (string.IsNullOrWhiteSpace(rawDesc))
                            {
                                <div class="py-12 text-center bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                                    <p class="text-slate-400 italic">Nội dung đang được cập nhật...</p>
                                </div>
                            }
                        </div>
                        <div id="desc-gradient" class="absolute bottom-0 left-0 w-full h-40 bg-gradient-to-t from-white via-white/95 to-transparent pointer-events-none transition-opacity duration-300"></div>
                    </div>

                    <div class="flex justify-center mt-8">
                        <button id="toggleContentBtn" class="group flex items-center gap-2 px-10 py-3 bg-white border border-slate-200 hover:border-[#00D1E4] hover:text-[#00D1E4] text-slate-700 font-bold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 relative z-10">
                            <span>Đọc toàn bộ</span>
                            <i class="fa-solid fa-chevron-down text-xs group-hover:translate-y-0.5 transition-transform"></i>
                        </button>
                    </div>
                </div>

                <div id="thong-so" class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 scroll-mt-24">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="w-1.5 h-6 bg-[#00D1E4] rounded-full"></span>
                        <h2 class="text-xl font-extrabold text-slate-900 uppercase tracking-tight">Thông số kỹ thuật</h2>
                    </div>

                    @if (p.Specifications != null && p.Specifications.Any())
                    {
                        <div class="rounded-xl border border-slate-200 overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <tbody class="divide-y divide-slate-100">
                                    @foreach (var s in p.Specifications.OrderBy(x => x.SortOrder).Take(10))
                                    {
                                        <tr class="hover:bg-slate-50 transition">
                                            <td class="px-6 py-4 text-slate-500 font-medium w-1/3 bg-white border-r border-slate-50">@s.Name</td>
                                            <td class="px-6 py-4 text-slate-900 font-semibold bg-white">@s.Value</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (p.Specifications.Count > 10)
                        {
                            <div class="text-center mt-4">
                                <button id="specModalBtn" class="text-sm font-bold text-[#00D1E4] hover:underline inline-flex items-center gap-1">
                                    Xem đầy đủ thông số <i class="fa-solid fa-arrow-right-long"></i>
                                </button>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-center text-slate-400 italic py-6">Đang cập nhật thông số...</p>
                    }
                </div>

            </div>

            <div class="lg:col-span-4 relative z-10">
                <div class="sticky top-24 space-y-6">

                    @if (p.Brand != null)
                    {
                        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden hover:shadow-md hover:border-[#00D1E4] transition-all duration-300 group">
                            <div class="bg-slate-50 px-4 py-2 border-b border-slate-100 flex items-center gap-2">
                                <i class="fa-solid fa-shield-halved text-[#00D1E4] text-sm"></i>
                                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Nhà bán lẻ chính thức</span>
                            </div>

                            <a href="@Url.Action("Index", "Products", new { brandFilter = p.BrandId })" class="p-4 flex items-center gap-4">
                                <div class="w-16 h-16 rounded-xl border border-slate-200 p-1 flex items-center justify-center bg-white shrink-0 shadow-sm overflow-hidden relative group-hover:border-[#00D1E4] transition-colors">
                                    <img src="@brandLogoUrl" alt="@p.Brand.Name"
                                         class="w-full h-full object-contain object-center z-10 relative"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                    <div class="absolute inset-0 flex items-center justify-center bg-slate-50 text-slate-300" style="display:none">
                                        <i class="fa-solid fa-store text-2xl"></i>
                                    </div>
                                </div>

                                <div class="flex-1 min-w-0">
                                    <h3 class="font-extrabold text-lg text-slate-900 leading-none mb-1 group-hover:text-[#00D1E4] transition-colors truncate">
                                        @p.Brand.Name
                                    </h3>
                                    <div class="flex items-center gap-1 text-xs font-medium text-slate-400 group-hover:text-[#00D1E4] transition-colors">
                                        Xem tất cả sản phẩm <i class="fa-solid fa-arrow-right-long"></i>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }

                    <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm relative overflow-hidden">
                        <h1 class="text-2xl font-extrabold text-slate-900 leading-snug mb-3">@p.Name</h1>

                        <div class="flex flex-wrap items-center gap-2 mb-6">
                            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md bg-slate-100 text-slate-600 text-[10px] font-bold font-mono border border-slate-200">
                                SKU: @(p.SKU ?? "N/A")
                            </span>
                            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md bg-green-50 text-green-700 text-[10px] font-bold border border-green-100">
                                <i class="fa-solid fa-box text-[9px]"></i> Sẵn hàng
                            </span>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div class="bg-white rounded-xl p-3 flex flex-col justify-center text-center h-[70px] border border-slate-200 shadow-sm">
                                <span class="text-[10px] text-slate-400 font-bold uppercase mb-1">Năm SX</span>
                                <span class="text-sm font-bold text-slate-900">@p.Year</span>
                            </div>
                            <div class="bg-white rounded-xl p-3 flex flex-col justify-center text-center h-[70px] border border-slate-200 shadow-sm">
                                <span class="text-[10px] text-slate-400 font-bold uppercase mb-1">@spec_EngineLabel</span>
                                <span class="text-sm font-bold text-slate-900 truncate px-1" title="@spec_EngineValue">@spec_EngineValue</span>
                            </div>
                            <div class="bg-white rounded-xl p-3 flex flex-col justify-center text-center h-[70px] border border-slate-200 shadow-sm">
                                <span class="text-[10px] text-slate-400 font-bold uppercase mb-1">Trọng lượng</span>
                                <span class="text-sm font-bold text-slate-900 truncate px-1">@spec_WeightValue</span>
                            </div>
                            <div class="bg-white rounded-xl p-3 flex flex-col justify-center text-center h-[70px] border border-slate-200 shadow-sm">
                                <span class="text-[10px] text-slate-400 font-bold uppercase mb-1">Bảo hành</span>
                                <span class="text-sm font-bold text-slate-900">3 Năm</span>
                            </div>
                        </div>

                        <div class="bg-[#F8FAFC] rounded-xl p-5 border border-slate-200/60 mb-6 text-center">
                            <div class="flex items-center justify-center gap-3">
                                <span class="text-3xl font-extrabold text-[#FD4057] tracking-tight">@FormatPrice(price)</span>
                            </div>
                            @if (hasSale)
                            {
                                <div class="flex items-center justify-center gap-2 mt-1">
                                    <span class="text-sm text-slate-400 line-through">@FormatPrice(original!.Value)</span>
                                    <span class="text-[10px] font-bold text-white bg-[#FD4057] px-1.5 py-0.5 rounded shadow-sm">-@discountPercent%</span>
                                </div>
                            }
                        </div>

                        <div class="space-y-3">
                            @if (inStock)
                            {
                                <button onclick="handleBuyAction('@p.Id', true)" class="w-full bg-gradient-to-r from-[#00D1E4] to-[#00b8c9] hover:shadow-lg hover:shadow-cyan-200/50 text-white font-bold py-4 rounded-xl text-base uppercase tracking-wide transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 shadow-md">
                                    Mua Ngay <i class="fa-solid fa-bolt text-yellow-300 animate-pulse"></i>
                                </button>
                                <button onclick="handleBuyAction('@p.Id', false)" class="w-full bg-white border-2 border-slate-200 hover:border-[#00D1E4] hover:text-[#00D1E4] text-slate-700 font-bold py-3.5 rounded-xl transition-all flex items-center justify-center gap-2 text-sm">
                                    <i class="fa-solid fa-cart-plus"></i> Thêm vào giỏ
                                </button>
                            }
                            else
                            {
                                <button class="w-full bg-slate-200 text-slate-400 font-bold py-4 rounded-xl cursor-not-allowed flex flex-col items-center justify-center">
                                    <span class="flex items-center gap-2 text-sm"><i class="fa-regular fa-bell-slash"></i> Tạm hết hàng</span>
                                </button>
                            }
                        </div>

                        <div class="grid grid-cols-2 gap-4 mt-6 pt-4 border-t border-dashed border-slate-300">
                            <div class="text-center border-r border-slate-300">
                                <div class="text-[10px] text-slate-500 uppercase font-semibold">Trả góp 0%</div>
                                <div class="text-xs font-bold text-slate-900 mt-0.5">Visa, Master</div>
                            </div>
                            <div class="text-center">
                                <div class="text-[10px] text-slate-500 uppercase font-semibold">Duyệt hồ sơ</div>
                                <div class="text-xs font-bold text-slate-900 mt-0.5">Nhanh 15p</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-4 border-b border-slate-100 bg-slate-50">
                            <h3 class="font-bold text-xs text-slate-800 uppercase tracking-wide mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-location-dot text-[#00D1E4]"></i> Tình trạng kho hàng
                            </h3>
                            <div class="flex p-1 bg-slate-200 rounded-xl gap-1">
                                <button class="loc-tab-btn flex-1 py-2 rounded-lg text-[10px] font-bold transition-all duration-200 active text-slate-900 bg-white shadow-sm uppercase" data-target="north">
                                    Miền Bắc (@branchesNorth.Count)
                                </button>
                                <button class="loc-tab-btn flex-1 py-2 rounded-lg text-[10px] font-bold transition-all duration-200 text-slate-500 hover:text-slate-700 hover:bg-slate-200/50 uppercase" data-target="central">
                                    Miền Trung (@branchesCentral.Count)
                                </button>
                                <button class="loc-tab-btn flex-1 py-2 rounded-lg text-[10px] font-bold transition-all duration-200 text-slate-500 hover:text-slate-700 hover:bg-slate-200/50 uppercase" data-target="south">
                                    Miền Nam (@branchesSouth.Count)
                                </button>
                            </div>
                        </div>

                        <div class="max-h-[250px] overflow-y-auto scrollbar-thin p-3">
                            <div id="list-north" class="loc-list block space-y-2">
                                @if (branchesNorth.Any())
                                {
                                    foreach (var b in branchesNorth)
                                    {
                                        <div class="p-3 border border-slate-100 rounded-xl bg-white hover:border-[#00D1E4] hover:shadow-md transition-all group relative">
                                            <div class="text-xs font-bold text-slate-800 mb-1 pr-12 truncate">@b.Name</div>
                                            <div class="text-[10px] text-slate-500 mb-2 line-clamp-1" title="@b.Address"><i class="fa-solid fa-map-pin mr-1"></i> @b.Address</div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-[10px] text-[#00AA45] bg-[#E6F9EE] px-2 py-0.5 rounded-md font-bold flex items-center gap-1 border border-[#B8EBD0]"><i class="fa-solid fa-check text-[8px]"></i> Sẵn xe</span>
                                                <a href="tel:@b.Phone" class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-500 border border-slate-200 hover:bg-[#00D1E4] hover:text-white hover:border-[#00D1E4] transition"><i class="fa-solid fa-phone text-xs"></i></a>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {

                                    <div class="text-center py-6 text-slate-400 text-xs italic">Tạm hết hàng tại Miền Bắc</div>
                                }
                            </div>

                            <div id="list-central" class="loc-list hidden space-y-2">
                                @if (branchesCentral.Any())
                                {
                                    foreach (var b in branchesCentral)
                                    {
                                        <div class="p-3 border border-slate-100 rounded-xl bg-white hover:border-[#00D1E4] hover:shadow-md transition-all group relative">
                                            <div class="text-xs font-bold text-slate-800 mb-1 pr-12 truncate">@b.Name</div>
                                            <div class="text-[10px] text-slate-500 mb-2 line-clamp-1" title="@b.Address"><i class="fa-solid fa-map-pin mr-1"></i> @b.Address</div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-[10px] text-[#00AA45] bg-[#E6F9EE] px-2 py-0.5 rounded-md font-bold flex items-center gap-1 border border-[#B8EBD0]"><i class="fa-solid fa-check text-[8px]"></i> Sẵn xe</span>
                                                <a href="tel:@b.Phone" class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-500 border border-slate-200 hover:bg-[#00D1E4] hover:text-white hover:border-[#00D1E4] transition"><i class="fa-solid fa-phone text-xs"></i></a>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {

                                    <div class="text-center py-6 text-slate-400 text-xs italic">Tạm hết hàng tại Miền Trung</div>
                                }
                            </div>

                            <div id="list-south" class="loc-list hidden space-y-2">
                                @if (branchesSouth.Any())
                                {
                                    foreach (var b in branchesSouth)
                                    {
                                        <div class="p-3 border border-slate-100 rounded-xl bg-white hover:border-[#00D1E4] hover:shadow-md transition-all group relative">
                                            <div class="text-xs font-bold text-slate-800 mb-1 pr-12 truncate">@b.Name</div>
                                            <div class="text-[10px] text-slate-500 mb-2 line-clamp-1" title="@b.Address"><i class="fa-solid fa-map-pin mr-1"></i> @b.Address</div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-[10px] text-[#00AA45] bg-[#E6F9EE] px-2 py-0.5 rounded-md font-bold flex items-center gap-1 border border-[#B8EBD0]"><i class="fa-solid fa-check text-[8px]"></i> Sẵn xe</span>
                                                <a href="tel:@b.Phone" class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-500 border border-slate-200 hover:bg-[#00D1E4] hover:text-white hover:border-[#00D1E4] transition"><i class="fa-solid fa-phone text-xs"></i></a>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {

                                    <div class="text-center py-6 text-slate-400 text-xs italic">Tạm hết hàng tại Miền Nam</div>
                                }
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div> @if (Model.RelatedProducts != null && Model.RelatedProducts.Any())
        {
            <div class="mt-16 pt-10 border-t border-slate-200">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Sản phẩm tương tự</h2>
                    <a href="@Url.Action("Index", "Products", new { categoryFilter = p.CategoryId })" class="text-sm font-bold text-[#00D1E4] hover:underline">Xem tất cả</a>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
                    @foreach (var item in Model.RelatedProducts.Take(5))
                    {
                        <div class="bg-white border border-slate-200 rounded-2xl p-4 hover:shadow-lg transition group relative">
                            <a href="@Url.Action("Details", "Products", new { id = item.Id })" class="block">
                                <div class="aspect-square mb-4 flex items-center justify-center bg-[#F9FAFB] rounded-xl">
                                    <img src="@Url.Content(item.PrimaryImageUrl ?? "/images/placeholders/product.webp")"
                                         class="w-full h-full object-contain p-2 group-hover:scale-110 transition duration-500" />
                                </div>
                                <h3 class="text-sm font-bold text-slate-800 line-clamp-2 h-10 mb-2 group-hover:text-[#00D1E4] transition">@item.Name</h3>
                                <div class="text-[#FD4057] font-bold">@FormatPrice(item.Price)</div>
                            </a>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

<div id="specModal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" id="closeSpecModalBackdrop"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative w-full max-w-3xl bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-slate-900">Thông số kỹ thuật: @p.Name</h3>
                    <button id="closeSpecModalBtn" class="text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="p-6 max-h-[70vh] overflow-y-auto">
                    @if (p.Specifications != null)
                    {
                        <table class="w-full text-sm text-left border-collapse">
                            <tbody class="divide-y divide-slate-100">
                                @foreach (var s in p.Specifications.OrderBy(x => x.SortOrder))
                                {
                                    <tr class="hover:bg-slate-50">
                                        <td class="py-3 px-4 text-slate-500 font-medium w-1/3 bg-white border-r border-slate-50">@s.Name</td>
                                        <td class="py-3 px-4 text-slate-900 font-semibold bg-white">@s.Value</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/js/productdetails.js"></script>