@model MotorShop.Models.Product
@using System.Globalization

@{
    string Price(decimal x) => string.Format(CultureInfo.GetCultureInfo("vi-VN"), "{0:N0} ₫", x);

    var price = Model.Price;
    decimal? old = Model.OriginalPrice;
    var hasSale = old.HasValue && old.Value > price;
    var discount = hasSale ? Math.Round((1 - (price / old.Value)) * 100) : 0;

    var img = !string.IsNullOrWhiteSpace(Model.ImageUrl)
        ? Model.ImageUrl
        : (Model.Images?.OrderBy(i => i.SortOrder).FirstOrDefault()?.ImageUrl
           ?? "~/images/placeholders/product-card.webp");
}

<div class="group bg-white border rounded-2xl shadow-sm hover:shadow-md transition overflow-hidden">
    <a asp-controller="Products" asp-action="Details" asp-route-id="@Model.Id" class="block">
        <div class="aspect-[4/3] bg-white grid place-items-center overflow-hidden">
            <img src="@Url.Content(img)" alt="@Model.Name"
                 class="w-full h-full object-contain group-hover:scale-[1.02] transition" />
        </div>
        <div class="p-4">
            <h3 class="font-semibold text-gray-900 line-clamp-2">@Model.Name</h3>

            <div class="mt-2">
                @if (hasSale)
                {
                    <div class="flex items-baseline gap-2">
                        <span class="text-lg font-bold text-gray-900">@Price(price)</span>
                        <span class="text-sm line-through text-gray-400">@Price(old!.Value)</span>
                        <span class="ml-auto text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-semibold">-@discount%</span>
                    </div>
                }
                else
                {
                    <div class="text-lg font-bold text-gray-900">@Price(price)</div>
                }
            </div>

            <div class="mt-3 text-sm text-gray-600">
                @if (Model.StockQuantity > 0)
                {
                    <span class="text-green-700">Còn @Model.StockQuantity</span>
                }
                else
                {

                    <span class="text-amber-600">Tạm hết hàng</span>
                }
            </div>
        </div>
    </a>

    <div class="px-4 pb-4">
        <button type="button"
                class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700"
                onclick="addToCart(@Model.Id, 1, this)">
            <i class="fa-solid fa-cart-plus"></i> Thêm vào giỏ
        </button>
    </div>
</div>

<script>
    // Định nghĩa 1 lần
    (function () {
      if (window.addToCart) return;

      window.addToCart = async function (productId, qty, btn) {
        const csrf = (window.getCsrf && window.getCsrf()) ||
                     document.querySelector('#af-global input[name="__RequestVerificationToken"]')?.value || '';

        // UI loading nhỏ
        let html;
        if (btn) { html = btn.innerHTML; btn.disabled = true; btn.classList.add('opacity-70');
                   btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang thêm...'; }

        try {
          const res = await fetch('@Url.Action("AddToCart", "Cart")', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'RequestVerificationToken': csrf
            },
            body: JSON.stringify({ productId: Number(productId), quantity: Number(qty) || 1 })
          });

          const ct = res.headers.get('content-type') || '';
          const data = ct.includes('application/json') ? await res.json() : null;

          if (res.ok && data?.success) {
            (window.showToast || alert)(data.message || 'Đã thêm vào giỏ', 'success');
            window.refreshCartBadge && window.refreshCartBadge();
          } else {
            const msg = data?.message || (res.status === 400 ? 'Thiếu/không hợp lệ CSRF token.' : 'Không thể thêm vào giỏ.');
            (window.showToast || alert)(msg, 'error');
          }
        } catch {
          (window.showToast || alert)('Lỗi kết nối. Thử lại sau.', 'error');
        } finally {
          if (btn) { btn.disabled = false; btn.classList.remove('opacity-70'); btn.innerHTML = html; }
        }
      };
    })();
</script>
