@model MotorShop.ViewModels.UpdateProfileViewModel
@using MotorShop.Utilities

@{
    ViewData["Title"] = "Hồ sơ của tôi";
}

<section class="min-h-screen bg-gray-50 flex items-center py-12 sm:px-6 lg:px-8">
    <div class="mx-auto w-full max-w-3xl">
        <!-- Card -->
        <div class="bg-white/90 backdrop-blur border border-gray-100 shadow-xl rounded-2xl p-6 sm:p-8">
            <div class="flex items-start sm:items-center sm:flex-row flex-col gap-5 sm:gap-6">
                <!-- Avatar -->
                <div class="shrink-0">
                    <div class="relative w-28 h-28 rounded-2xl overflow-hidden ring-1 ring-gray-200 shadow">
                        @if (!string.IsNullOrWhiteSpace(Model?.CurrentAvatarUrl))
                        {
                            <img id="avatarPreview" src="@Model.CurrentAvatarUrl" alt="Avatar"
                                 class="w-full h-full object-cover" />
                        }
                        else
                        {
                            <img id="avatarPreview" src="~/images/avatars/default-avatar.png" alt="Avatar mặc định"
                                 class="w-full h-full object-cover opacity-90" />
                        }
                        <div class="absolute inset-0 pointer-events-none bg-gradient-to-t from-black/10 to-transparent"></div>
                    </div>
                </div>

                <div class="flex-1">
                    <h1 class="text-3xl font-extrabold text-gray-900">@ViewData["Title"]</h1>
                    <p class="mt-1 text-sm text-gray-600">Cập nhật thông tin liên hệ, địa chỉ và ảnh đại diện.</p>

                    <div class="mt-3 flex flex-wrap gap-2 text-sm">
                        <a asp-action="ChangePassword"
                           class="inline-flex gap-2 items-center px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50">
                            <i class="fa-solid fa-key text-gray-700"></i> Đổi mật khẩu
                        </a>
                        <a asp-action="Email"
                           class="inline-flex gap-2 items-center px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50">
                            <i class="fa-solid fa-at text-gray-700"></i> Quản lý email
                        </a>
                        <a asp-action="ExportMyData"
                           class="inline-flex gap-2 items-center px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50">
                            <i class="fa-regular fa-file-code text-gray-700"></i> Xuất dữ liệu cá nhân (JSON)
                        </a>
                    </div>
                </div>
            </div>

            <!-- TempData alerts -->
            @if (TempData[SD.Temp_Success] is string ok)
            {
                <div class="mt-5 rounded-md bg-green-50 p-4 text-green-700">@ok</div>
            }
            @if (TempData[SD.Temp_Info] is string inf)
            {
                <div class="mt-5 rounded-md bg-blue-50 p-4 text-blue-700">@inf</div>
            }
            @if (TempData[SD.Temp_Warning] is string warn)
            {
                <div class="mt-5 rounded-md bg-yellow-50 p-4 text-yellow-800">@warn</div>
            }
            @if (TempData[SD.Temp_Error] is string er)
            {
                <div class="mt-5 rounded-md bg-red-50 p-4 text-red-700">@er</div>
            }

            <!-- Profile form -->
            <form asp-action="Index" method="post" enctype="multipart/form-data" class="mt-6 space-y-6" novalidate>
                @Html.AntiForgeryToken()

                <div asp-validation-summary="ModelOnly" class="hidden"></div>
                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="rounded-md bg-red-50 p-4 mb-2 text-sm text-red-700">
                        @foreach (var err in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <div>@err.ErrorMessage</div>
                        }
                    </div>
                }

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tên đăng nhập</label>
                        <input value="@Model.Username" disabled
                               class="mt-1 block w-full bg-gray-50 text-gray-600 rounded-xl border-gray-200 shadow-sm" />
                        <p class="text-xs text-gray-400 mt-1">Không thể thay đổi tên đăng nhập tại đây.</p>
                    </div>

                    <div>
                        <label asp-for="FullName" class="block text-sm font-medium text-gray-700"></label>
                        <input asp-for="FullName"
                               class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                        <span asp-validation-for="FullName" class="text-sm text-red-600"></span>
                    </div>

                    <div>
                        <label asp-for="PhoneNumber" class="block text-sm font-medium text-gray-700"></label>
                        <input asp-for="PhoneNumber" inputmode="tel" autocomplete="tel"
                               class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                        <span asp-validation-for="PhoneNumber" class="text-sm text-red-600"></span>
                    </div>

                    <div class="sm:col-span-2">
                        <label asp-for="Address" class="block text-sm font-medium text-gray-700"></label>
                        <textarea asp-for="Address" rows="3"
                                  class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <span asp-validation-for="Address" class="text-sm text-red-600"></span>
                    </div>

                    <div class="sm:col-span-2">
                        <label asp-for="AvatarFile" class="block text-sm font-medium text-gray-700">Ảnh đại diện</label>
                        <div class="mt-1 flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-gray-300 bg-white hover:bg-gray-50 cursor-pointer">
                                <i class="fa-solid fa-upload text-gray-700"></i>
                                <span>Chọn ảnh...</span>
                                <input asp-for="AvatarFile" type="file" accept="image/*" class="hidden" onchange="previewAvatar(this)" />
                            </label>
                            <span class="text-xs text-gray-500">Tối đa @((SD.MaxUploadBytes/(1024*1024)))MB — @string.Join('/', SD.AllowedImageExtensions)</span>
                        </div>
                        <span asp-validation-for="AvatarFile" class="text-sm text-red-600"></span>

                        @if (!string.IsNullOrWhiteSpace(Model?.CurrentAvatarUrl))
                        {
                            <form asp-action="RemoveAvatar" method="post" class="mt-3 inline">
                                @Html.AntiForgeryToken()
                                <button type="submit"
                                        class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-red-200 text-red-700 bg-red-50 hover:bg-red-100">
                                    <i class="fa-regular fa-trash-can"></i> Xoá ảnh hiện tại
                                </button>
                            </form>
                        }
                    </div>
                </div>

                <div class="pt-2">
                    <button type="submit"
                            class="w-full sm:w-auto inline-flex justify-center items-center gap-2 px-5 py-3 rounded-xl shadow-sm text-white bg-blue-600 hover:bg-blue-700 font-semibold">
                        <i class="fa-solid fa-floppy-disk"></i> Lưu thay đổi
                    </button>
                </div>
            </form>

            <!-- Advanced / Security -->
            <div class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 border rounded-xl">
                    <div class="flex items-center gap-2 text-gray-800 font-semibold mb-2">
                        <i class="fa-solid fa-shield-halved text-blue-600"></i> Bảo mật
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <form asp-action="ToggleTwoFactor" method="post" class="inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="enable" value="true" />
                            <button class="px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50">Bật 2FA</button>
                        </form>
                        <form asp-action="ToggleTwoFactor" method="post" class="inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="enable" value="false" />
                            <button class="px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50">Tắt 2FA</button>
                        </form>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Bật 2 lớp xác thực để tăng an toàn cho tài khoản.</p>
                </div>

                <div class="p-4 border rounded-xl">
                    <div class="flex items-center gap-2 text-gray-800 font-semibold mb-2">
                        <i class="fa-solid fa-right-from-bracket text-orange-500"></i> Phiên đăng nhập
                    </div>
                    <form asp-action="SignOutAll" method="post">
                        @Html.AntiForgeryToken()
                        <button class="px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50">
                            Đăng xuất khỏi tất cả thiết bị
                        </button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2">Hữu ích khi bạn lỡ đăng nhập ở máy lạ.</p>
                </div>

                <div class="p-4 border rounded-xl">
                    <div class="flex items-center gap-2 text-gray-800 font-semibold mb-2">
                        <i class="fa-regular fa-file-code text-emerald-600"></i> Dữ liệu cá nhân
                    </div>
                    <a asp-action="ExportMyData" class="px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50 inline-block">
                        Tải JSON hồ sơ + đơn hàng
                    </a>
                    <p class="text-xs text-gray-500 mt-2">Bạn có thể lưu trữ/lưu chứng từ mua hàng.</p>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function previewAvatar(input) {
            if (!input?.files?.length) return;
            const file = input.files[0];
            const url = URL.createObjectURL(file);
            const img = document.getElementById('avatarPreview');
            if (img) img.src = url;
        }
    </script>
}
