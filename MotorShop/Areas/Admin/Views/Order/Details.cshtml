@model MotorShop.Models.Order
@using MotorShop.Models.Enums
@{
    ViewData["Title"] = $"Đơn hàng #{Model.Id}";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";

    var risk = ViewBag.RiskInfo as dynamic;
    var sla = ViewBag.SlaInfo as dynamic;
    var cusStats = ViewBag.CustomerStats as dynamic;
    var shippers = ViewBag.Shippers as IEnumerable<MotorShop.Models.Shipper>;
}

@section Head {
    <style>
        :root {
            --primary-grad: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.08);
            --shadow-sharp: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        body {
            background-color: #f3f4f6;
        }

        /* --- CARDS & CONTAINERS --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: 20px;
            box-shadow: var(--shadow-soft);
            transition: transform 0.2s ease;
        }

        .customer-avatar-lg {
            width: 80px;
            height: 80px;
            border-radius: 24px;
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            color: #4f46e5;
            font-size: 32px;
            font-weight: 800;
            display: grid;
            place-items: center;
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4);
        }

        /* --- TIMELINE NÂNG CẤP --- */
        .timeline-modern {
            position: relative;
            padding: 20px 0;
            margin-top: 10px;
        }

        .timeline-track {
            position: absolute;
            top: 35px;
            left: 0;
            right: 0;
            height: 6px;
            background: #e5e7eb;
            border-radius: 10px;
            z-index: 0;
        }

        .timeline-fill {
            position: absolute;
            top: 35px;
            left: 0;
            height: 6px;
            background: #10b981;
            border-radius: 10px;
            z-index: 0;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .timeline-item {
            position: relative;
            z-index: 1;
            text-align: center;
            width: 16.66%;
            float: left;
        }

        .timeline-icon {
            width: 36px;
            height: 36px;
            margin: 0 auto 10px;
            background: #fff;
            border: 3px solid #e5e7eb;
            border-radius: 50%;
            display: grid;
            place-items: center;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s;
        }

        .timeline-item.active .timeline-icon {
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
            background: #fff;
            color: #10b981;
        }

        .timeline-item.completed .timeline-icon {
            background: #10b981;
            border-color: #10b981;
            color: #fff;
        }

        .timeline-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #9ca3af;
        }

        .timeline-item.active .timeline-label, .timeline-item.completed .timeline-label {
            color: #059669;
        }

        /* --- MODAL SHIPPER ĐẸP --- */
        .modal-shipper .modal-content {
            border-radius: 24px;
            border: none;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header-banner {
            background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
            padding: 30px;
            text-align: center;
        }

        .shipper-select-box {
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 5px;
            transition: all 0.2s;
        }

            .shipper-select-box:focus-within {
                border-color: #f59e0b;
                box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
            }

        .form-select-custom {
            border: none;
            font-size: 16px;
            font-weight: 600;
            padding: 12px;
            width: 100%;
            outline: none;
            background: transparent;
        }

        /* --- TABLE --- */
        .table-custom th {
            font-size: 11px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: #6b7280;
            font-weight: 700;
            border-bottom: 1px solid #f3f4f6;
        }

        .table-custom td {
            vertical-align: middle;
            padding: 16px 12px;
        }

        .product-thumb {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            object-fit: cover;
            border: 1px solid #f3f4f6;
        }
    </style>
}

@* --- HEADER --- *@
<div class="d-flex justify-content-between align-items-end mb-4 fade-in-up">
    <div>
        <div class="d-flex align-items-center gap-2 text-muted mb-1 small fw-bold">
            <i class="bi bi-clock-history"></i> @Model.OrderDate.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
        </div>
        <div class="d-flex align-items-center gap-3">
            <a href="/Admin/Order" class="btn btn-white rounded-circle shadow-sm" style="width:40px;height:40px;display:grid;place-items:center"><i class="bi bi-arrow-left"></i></a>
            <h1 class="h2 fw-bolder mb-0 text-dark">Đơn hàng #@Model.Id</h1>

            @* Badge trạng thái hiện tại *@
            @{
                string statusColor = Model.Status switch
                {
                    OrderStatus.Completed => "success",
                    OrderStatus.Cancelled => "danger",
                    OrderStatus.Shipping => "primary",
                    OrderStatus.Processing => "info",
                    _ => "secondary"
                };
            }
            <span class="badge bg-@statusColor-subtle text-@statusColor rounded-pill px-3 py-2 border border-@statusColor-subtle">
                @Model.Status
            </span>
        </div>
    </div>

    <div class="d-flex gap-2">
        <a asp-action="PrintInvoice" asp-route-id="@Model.Id" target="_blank" class="btn btn-light fw-bold border shadow-sm">
            <i class="bi bi-printer me-2"></i>In đơn
        </a>

        @if (Model.Status != OrderStatus.Cancelled && Model.Status != OrderStatus.Completed)
        {
            <div class="dropdown">
                <button class="btn btn-primary fw-bold shadow-lg px-4 py-2 dropdown-toggle" data-bs-toggle="dropdown" style="background: var(--primary-grad); border:none;">
                    Xử lý đơn hàng
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-4 p-2 mt-2" style="min-width: 240px;">
                    <li><h6 class="dropdown-header text-uppercase small fw-bolder text-muted">Trạng thái tiếp theo</h6></li>

                    @if (Model.Status == OrderStatus.Pending)
                    {
                        <li><button class="dropdown-item rounded-3 fw-bold py-2 text-success" onclick="checkAndSubmit(@((int)OrderStatus.Confirmed))"><i class="bi bi-check-lg me-2"></i>Xác nhận đơn</button></li>
                    }
                    @if (Model.Status == OrderStatus.Confirmed)
                    {
                        <li><button class="dropdown-item rounded-3 fw-bold py-2 text-info" onclick="checkAndSubmit(@((int)OrderStatus.Processing))"><i class="bi bi-gear-wide me-2"></i>Đóng gói & Xử lý</button></li>
                    }
                    @if (Model.Status == OrderStatus.Processing)
                    {
                        <li><button class="dropdown-item rounded-3 fw-bold py-2 text-warning" onclick="checkAndSubmit(@((int)OrderStatus.Shipping))"><i class="bi bi-truck me-2"></i>Giao cho vận chuyển</button></li>
                    }
                    @if (Model.Status == OrderStatus.Shipping)
                    {
                        <li><button class="dropdown-item rounded-3 fw-bold py-2 text-primary" onclick="checkAndSubmit(@((int)OrderStatus.Delivered))"><i class="bi bi-box-seam me-2"></i>Đã giao khách</button></li>
                    }
                    @if (Model.Status == OrderStatus.Delivered)
                    {
                        <li><button class="dropdown-item rounded-3 fw-bold py-2 text-success" onclick="checkAndSubmit(@((int)OrderStatus.Completed))"><i class="bi bi-check-all me-2"></i>Hoàn tất đơn</button></li>
                    }
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item rounded-3 fw-bold py-2 text-danger" onclick="checkAndSubmit(@((int)OrderStatus.Cancelled))"><i class="bi bi-x-circle me-2"></i>Hủy đơn hàng</button></li>
                </ul>
            </div>
        }
    </div>
</div>

<form id="statusForm" asp-action="UpdateStatus" method="post">
    <input type="hidden" name="id" value="@Model.Id" />
    <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
    <input type="hidden" name="status" id="statusInput" />
    <input type="hidden" name="shipperId" id="shipperIdInput" value="@Model.ShipperId" />
</form>

<div class="row g-4">
    @* --- CỘT TRÁI: TIMELINE & SẢN PHẨM --- *@
    <div class="col-lg-8">
        <div class="glass-card p-4 mb-4">
            <h6 class="fw-bold text-uppercase text-muted mb-4 small ls-1">Tiến độ xử lý</h6>
            @{
                var steps = new[] { OrderStatus.Pending, OrderStatus.Confirmed, OrderStatus.Processing, OrderStatus.Shipping, OrderStatus.Delivered, OrderStatus.Completed };
                int currentIdx = Array.IndexOf(steps, Model.Status);
                int width = currentIdx >= 0 ? (currentIdx * 100 / (steps.Length - 1)) : 0;
                if (Model.Status == OrderStatus.Cancelled) width = 0;
            }
            <div class="timeline-modern clearfix">
                <div class="timeline-track"></div>
                @if (Model.Status != OrderStatus.Cancelled)
                {
                    <div class="timeline-fill" style="width: @width%"></div>
                }
                @for (int i = 0; i < steps.Length; i++)
                {
                    var s = steps[i];
                    string cls = (i < currentIdx) ? "completed" : (i == currentIdx ? "active" : "");
                    string icon = s switch
                    {
                        OrderStatus.Pending => "<i class='bi bi-hourglass'></i>",
                        OrderStatus.Confirmed => "<i class='bi bi-check'></i>",
                        OrderStatus.Processing => "<i class='bi bi-box'></i>",
                        OrderStatus.Shipping => "<i class='bi bi-truck'></i>",
                        OrderStatus.Delivered => "<i class='bi bi-house'></i>",
                        OrderStatus.Completed => "<i class='bi bi-star'></i>",
                        _ => ""
                    };
                    <div class="timeline-item @cls">
                        <div class="timeline-icon">@Html.Raw(icon)</div>
                        <div class="timeline-label">@s</div>
                    </div>
                }
            </div>
            @if (Model.Status == OrderStatus.Cancelled)
            {
                <div class="alert alert-danger border-0 bg-danger-subtle text-danger fw-bold text-center mt-4 mb-0 rounded-3">
                    <i class="bi bi-exclamation-octagon me-2"></i> Đơn hàng đã bị hủy
                </div>
            }
        </div>

        <div class="glass-card overflow-hidden">
            <div class="p-4 border-bottom bg-white bg-opacity-50">
                <h5 class="fw-bold m-0">Chi tiết sản phẩm <span class="badge bg-light text-dark border ms-2">@Model.OrderItems.Count món</span></h5>
            </div>
            <div class="table-responsive">
                <table class="table table-custom mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Sản phẩm</th>
                            <th class="text-center">Số lượng</th>
                            <th class="text-end">Đơn giá</th>
                            <th class="text-end pe-4">Tổng</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.OrderItems)
                        {
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center gap-3">
                                        <img src="@(item.Product?.PrimaryImageUrl ?? "/images/no-img.png")" class="product-thumb shadow-sm" />
                                        <div>
                                            <div class="fw-bold text-dark">@(item.Product?.Name ?? "Đã xóa")</div>
                                            <div class="small text-muted font-monospace">@item.Product?.SKU</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center fw-bold text-secondary">x @item.Quantity</td>
                                <td class="text-end text-muted">@item.UnitPrice.ToString("N0")</td>
                                <td class="text-end fw-bold text-dark pe-4">@((item.Quantity * item.UnitPrice).ToString("N0"))</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="bg-light bg-opacity-50">
                        <tr>
                            <td colspan="3" class="text-end text-muted py-3">Phí vận chuyển</td>
                            <td class="text-end fw-bold pe-4">@Model.ShippingFee.ToString("N0")</td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-end py-3 pt-0 align-middle"><span class="h6 fw-bold text-dark">Thành tiền</span></td>
                            <td class="text-end pe-4 py-3 pt-0">
                                <span class="h4 fw-bolder text-primary">@Model.TotalAmount.ToString("N0") ₫</span>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    @* --- CỘT PHẢI: KHÁCH HÀNG & SHIPPER --- *@
    <div class="col-lg-4">
        <div class="d-flex flex-column gap-4 h-100">
            <div class="glass-card p-4 text-center position-relative">
                <div class="customer-avatar-lg mx-auto mb-3">
                    @(Model.ReceiverName?.Substring(0, 1).ToUpper() ?? "U")
                </div>
                <h5 class="fw-bolder text-dark mb-1">@Model.ReceiverName</h5>
                <p class="text-muted small mb-3">@Model.ReceiverPhone</p>

                <div class="bg-light rounded-4 p-3 text-start">
                    <div class="d-flex gap-3 mb-2">
                        <i class="bi bi-geo-alt-fill text-danger fs-5"></i>
                        <span class="small fw-medium text-dark">@(Model.ShippingAddress ?? "Nhận tại cửa hàng")</span>
                    </div>
                </div>

                @if (cusStats != null)
                {
                    <div class="d-flex justify-content-between mt-3 px-2">
                        <div class="text-center">
                            <div class="small text-muted text-uppercase fw-bold" style="font-size:10px">Đơn hàng</div>
                            <div class="fw-bold fs-5">@cusStats.TotalOrders</div>
                        </div>
                        <div class="vr bg-secondary opacity-25"></div>
                        <div class="text-center">
                            <div class="small text-muted text-uppercase fw-bold" style="font-size:10px">Chi tiêu</div>
                            <div class="fw-bold fs-5 text-success">@(((double)cusStats.TotalSpent / 1000000).ToString("0.#"))M</div>
                        </div>
                    </div>
                }
            </div>

            <div class="glass-card flex-grow-1 p-4">
                <h6 class="fw-bold text-uppercase text-muted mb-4 small ls-1">Vận chuyển & Thanh toán</h6>

                <div class="mb-4">
                    <label class="small text-muted fw-bold d-block mb-2">ĐƠN VỊ VẬN CHUYỂN</label>
                    @if (Model.Shipper != null)
                    {
                        <div class="d-flex align-items-center gap-3 p-3 bg-white border rounded-3 shadow-sm">
                            <div class="rounded-circle bg-primary bg-opacity-10 text-primary p-2">
                                <i class="bi bi-truck fs-4"></i>
                            </div>
                            <div>
                                <div class="fw-bold text-dark">@Model.Shipper.Name</div>
                                <div class="small text-muted">@Model.DeliveryMethod</div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="p-3 border border-dashed rounded-3 text-center text-muted bg-light">
                            <i class="bi bi-truck me-2"></i> Chưa chỉ định shipper
                        </div>
                    }
                </div>

                <div>
                    <label class="small text-muted fw-bold d-block mb-2">THANH TOÁN</label>
                    <div class="d-flex justify-content-between align-items-center p-3 bg-white border rounded-3">
                        <span class="fw-bold text-dark">@Model.PaymentMethod</span>
                        @if (Model.PaymentStatus == PaymentStatus.Paid)
                        {
                            <span class="badge bg-success text-white rounded-pill"><i class="bi bi-check-circle-fill me-1"></i>Đã TT</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark rounded-pill"><i class="bi bi-hourglass-split me-1"></i>Chờ TT</span>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* --- MODAL SHIPPER ĐƯỢC THIẾT KẾ LẠI --- *@
<div class="modal fade modal-shipper" id="shipperModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header-banner">
                <div class="bg-white rounded-circle shadow-sm mx-auto d-flex align-items-center justify-content-center" style="width: 70px; height: 70px;">
                    <i class="bi bi-truck-front-fill text-warning fs-1"></i>
                </div>
                <h4 class="fw-bold mt-3 mb-1 text-dark">Chọn Đơn Vị Giao Hàng</h4>
                <p class="text-dark opacity-75 small mb-0">Đơn hàng chuyển sang trạng thái <strong>Shipping</strong> cần thông tin shipper.</p>
            </div>

            <div class="modal-body p-4 pt-2">
                <div class="form-group mt-3">
                    <label class="form-label fw-bold text-uppercase small text-muted ms-1">Danh sách đối tác</label>
                    <div class="shipper-select-box bg-white">
                        <select id="modalShipperSelect" class="form-select-custom">
                            <option value="">-- Vui lòng chọn Shipper --</option>
                            @if (shippers != null)
                            {
                                foreach (var s in shippers)
                                {
                                    <option value="@s.Id" selected="@(Model.ShipperId == s.Id)">🚛 &nbsp; @s.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="form-text ms-1 mt-2 text-muted">
                        <i class="bi bi-info-circle me-1"></i> Shipper sẽ nhận được thông báo sau khi bạn xác nhận.
                    </div>
                </div>
            </div>

            <div class="modal-footer border-top-0 px-4 pb-4 pt-0 justify-content-between">
                <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Để sau</button>
                <button type="button" class="btn btn-primary rounded-pill px-5 fw-bold shadow-lg"
                        style="background: var(--primary-grad); border:none;"
                        onclick="confirmShipperAndSubmit()">
                    Xác nhận & Lưu
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const STATUS_SHIPPING = @((int)OrderStatus.Shipping);
        const STATUS_DELIVERED = @((int)OrderStatus.Delivered);
        const STATUS_COMPLETED = @((int)OrderStatus.Completed);

        let pendingStatusId = 0;

        function checkAndSubmit(statusId) {
            const statusNeedsShipper = [STATUS_SHIPPING, STATUS_DELIVERED, STATUS_COMPLETED];

            if (statusNeedsShipper.includes(statusId)) {
                pendingStatusId = statusId;
                // Nếu đã có shipper rồi thì tự select trong modal (đã xử lý ở Razor),
                // nhưng vẫn hiện modal để user confirm hoặc đổi shipper khác
                var myModal = new bootstrap.Modal(document.getElementById('shipperModal'));
                myModal.show();
            } else {
                submitForm(statusId, null);
            }
        }

        function confirmShipperAndSubmit() {
            var selectedShipper = document.getElementById('modalShipperSelect').value;

            if (!selectedShipper) {
                // Hiệu ứng rung lắc nếu chưa chọn
                var selectBox = document.querySelector('.shipper-select-box');
                selectBox.classList.add('border-danger');
                selectBox.animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-10px)' },
                    { transform: 'translateX(10px)' },
                    { transform: 'translateX(0)' }
                ], { duration: 300 });
                return;
            }

            submitForm(pendingStatusId, selectedShipper);
        }

        function submitForm(statusId, shipperId) {
            // SweetAlert hoặc confirm đơn giản
            if (confirm('Bạn có chắc chắn muốn cập nhật trạng thái đơn hàng?')) {
                document.getElementById('statusInput').value = statusId;
                if (shipperId) {
                    document.getElementById('shipperIdInput').value = shipperId;
                }
                document.getElementById('statusForm').submit();
            }
        }
    </script>
}