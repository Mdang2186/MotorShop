@model MotorShop.ViewModels.DashboardViewModel
@using System.Text.Json

@{
    ViewData["Title"] = "Dashboard Overview";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";

    string FormatMoney(decimal v) => v.ToString("N0") + " ₫";
}

@section Head {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 3D CARDS & NEON EFFECTS --- */
        .dashboard-container {
            animation: fadeUp 0.6s ease-out;
        }

        @@keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-3d {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

            .card-3d:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 40px -5px rgba(99, 102, 241, 0.15);
                border-color: rgba(99, 102, 241, 0.3);
            }

        /* Icon Box Neon */
        .icon-neon {
            width: 50px;
            height: 50px;
            border-radius: 16px;
            display: grid;
            place-items: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 8px 20px -5px rgba(0,0,0,0.3);
        }

        /* Gradient Text */
        .text-gradient {
            background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        /* Filter Bar */
        .filter-bar {
            background: white;
            padding: 8px 12px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            display: inline-flex;
            gap: 10px;
            align-items: center;
        }

        .input-pill {
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 13px;
            outline: none;
            transition: 0.2s;
        }

            .input-pill:focus {
                border-color: #6366f1;
                background: white;
            }

        /* Table Styles */
        .table-modern th {
            font-size: 11px;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 700;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f5f9;
        }

        .table-modern td {
            padding: 12px 0;
            border-bottom: 1px solid #f8fafc;
            font-size: 13px;
            vertical-align: middle;
        }

        .table-modern tr:last-child td {
            border-bottom: none;
        }

        .avatar-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-weight: bold;
            font-size: 12px;
            color: white;
        }
    </style>
}

<div class="dashboard-container">

    <div class="d-flex flex-wrap justify-content-between align-items-end mb-5">
        <div>
            <h2 class="fw-bolder mb-1 h3">Dashboard</h2>
            <p class="text-muted mb-0 small">Báo cáo hoạt động kinh doanh thời gian thực.</p>
        </div>

        <div class="d-flex gap-3 align-items-center">
            <form asp-action="Index" method="get" class="filter-bar">
                <input type="date" name="from" value="@(Model.From?.ToString("yyyy-MM-dd"))" class="input-pill" />
                <span class="text-muted small">to</span>
                <input type="date" name="to" value="@(Model.To?.ToString("yyyy-MM-dd"))" class="input-pill" />
                <button type="submit" class="btn btn-primary rounded-circle shadow-sm" style="width: 36px; height: 36px; padding: 0; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none;">
                    <i class="bi bi-arrow-right"></i>
                </button>
            </form>

            <div class="dropdown">
                <button class="btn btn-light rounded-circle shadow-sm" data-bs-toggle="dropdown" style="width: 40px; height: 40px;"><i class="bi bi-download"></i></button>
                <ul class="dropdown-menu shadow-lg border-0 rounded-4 p-2">
                    <li>
                        <form asp-action="ExportSummaryExcel" method="post">
                            <input type="hidden" name="from" value="@Model.From" /><input type="hidden" name="to" value="@Model.To" />
                            <button class="dropdown-item rounded-3"><i class="bi bi-file-earmark-excel text-success me-2"></i> Excel Report</button>
                        </form>
                    </li>
                    <li>
                        <form asp-action="ExportSummaryPdf" method="post">
                            <input type="hidden" name="from" value="@Model.From" /><input type="hidden" name="to" value="@Model.To" />
                            <button class="dropdown-item rounded-3"><i class="bi bi-file-earmark-pdf text-danger me-2"></i> PDF Report</button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-xl-3 col-md-6">
            <div class="card-3d">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="text-muted small fw-bold text-uppercase mb-2">Doanh thu</div>
                        <h3 class="text-gradient mb-0">@FormatMoney(Model.TotalRevenueInRange)</h3>
                        <div class="mt-2 badge bg-success-subtle text-success rounded-pill"><i class="bi bi-graph-up"></i> Thu nhập thực</div>
                    </div>
                    <div class="icon-neon" style="background: linear-gradient(135deg, #8b5cf6, #d946ef);"><i class="bi bi-currency-dollar"></i></div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card-3d">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="text-muted small fw-bold text-uppercase mb-2">Đơn hàng</div>
                        <h3 class="text-gradient mb-0">@Model.TotalOrdersInRange</h3>
                        <div class="mt-2 small text-muted">
                            <span class="text-success fw-bold">@Model.SuccessfulOrdersInRange</span> thành công
                        </div>
                    </div>
                    <div class="icon-neon" style="background: linear-gradient(135deg, #3b82f6, #06b6d4);"><i class="bi bi-bag-check"></i></div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card-3d">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="text-muted small fw-bold text-uppercase mb-2">Khách mới</div>
                        <h3 class="text-gradient mb-0">@Model.NewCustomersInRange</h3>
                        <div class="mt-2 badge bg-info-subtle text-info rounded-pill">+@Model.NewCustomersInRange user</div>
                    </div>
                    <div class="icon-neon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);"><i class="bi bi-people"></i></div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card-3d">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="text-muted small fw-bold text-uppercase mb-2">Đơn hủy</div>
                        <h3 class="text-gradient mb-0">@Model.CancelledOrdersInRange</h3>
                        <div class="mt-2 badge bg-danger-subtle text-danger rounded-pill">Cần chú ý</div>
                    </div>
                    <div class="icon-neon" style="background: linear-gradient(135deg, #ef4444, #f43f5e);"><i class="bi bi-x-octagon"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-8">
            <div class="card-3d">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold m-0">Biểu đồ doanh thu</h5>
                    <span class="badge bg-light text-dark border">Line Chart</span>
                </div>
                <div style="height: 300px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card-3d">
                <h5 class="fw-bold mb-4">Trạng thái đơn</h5>
                <div style="height: 220px; position: relative;">
                    <canvas id="statusChart"></canvas>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div class="h3 fw-bold m-0">@Model.TotalOrdersInRange</div>
                        <small class="text-muted text-uppercase" style="font-size: 10px;">Tổng đơn</small>
                    </div>
                </div>
                <div class="mt-4 text-center small text-muted">Tỷ lệ đơn hàng theo trạng thái xử lý</div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-6">
            <div class="card-3d">
                <h6 class="text-muted fw-bold text-uppercase small mb-3">Số lượng đơn / ngày</h6>
                <div style="height: 200px;">
                    <canvas id="orderCountChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card-3d">
                <h6 class="text-muted fw-bold text-uppercase small mb-3">Doanh thu theo danh mục</h6>
                <div style="height: 200px;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card-3d h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0">Top sản phẩm bán chạy</h5>
                    <a href="/Admin/Product" class="text-decoration-none small fw-bold">Xem kho</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-borderless table-modern mb-0">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th class="text-end">Đã bán</th>
                                <th class="text-end">Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.TopProducts.Any())
                            {
                                foreach (var p in Model.TopProducts)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center gap-3">
                                                <img src="@p.ImageUrl" class="rounded-3 border" style="width: 40px; height: 40px; object-fit: cover;" onerror="this.src='/images/no-img.png'" />
                                                <div>
                                                    <div class="fw-bold text-dark small text-truncate" style="max-width: 200px;">@p.ProductName</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-end fw-bold text-primary">@p.Quantity</td>
                                        <td class="text-end text-muted">@FormatMoney(p.Revenue)</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="3" class="text-center text-muted py-3">Chưa có dữ liệu</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card-3d h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0">Khách hàng VIP</h5>
                    <span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i> Top Chi Tiêu</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-borderless table-modern mb-0">
                        <thead>
                            <tr>
                                <th>Khách hàng</th>
                                <th class="text-end">Đơn hàng</th>
                                <th class="text-end">Tổng chi tiêu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.VipCustomers.Any())
                            {
                                foreach (var c in Model.VipCustomers)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="avatar-circle" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                                    @c.FullName?.Substring(0, 1).ToUpper()
                                                </div>
                                                <div>
                                                    <div class="fw-bold text-dark small">@c.FullName</div>
                                                    <div class="text-muted" style="font-size: 10px;">@c.Email</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-end fw-bold">@c.TotalOrders</td>
                                        <td class="text-end fw-bold text-success">@FormatMoney(c.TotalSpent)</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="3" class="text-center text-muted py-3">Chưa có dữ liệu</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        // Serialize Data for ChartJS
        var revLabels = JsonSerializer.Serialize(Model.RevenueChartLabels);
        var revData = JsonSerializer.Serialize(Model.RevenueChartData);
        var orderLabels = JsonSerializer.Serialize(Model.OrderCountChartLabels);
        var orderData = JsonSerializer.Serialize(Model.OrderCountChartData);
        var catLabels = JsonSerializer.Serialize(Model.RevenueByCategoryLabels);
        var catData = JsonSerializer.Serialize(Model.RevenueByCategoryData);
        var statusLabels = JsonSerializer.Serialize(Model.OrderStatusLabels);
        var statusData = JsonSerializer.Serialize(Model.OrderStatusCounts);
    }

    <script>
        Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
        Chart.defaults.color = '#64748b';

        // --- 1. Revenue Line Chart ---
        const ctxRev = document.getElementById('revenueChart').getContext('2d');
        const gradRev = ctxRev.createLinearGradient(0, 0, 0, 300);
        gradRev.addColorStop(0, 'rgba(139, 92, 246, 0.5)');
        gradRev.addColorStop(1, 'rgba(139, 92, 246, 0.0)');

        new Chart(ctxRev, {
            type: 'line',
            data: {
                labels: @Html.Raw(revLabels),
                datasets: [{
                    label: 'Doanh thu',
                    data: @Html.Raw(revData),
                    borderColor: '#8b5cf6',
                    backgroundColor: gradRev,
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#8b5cf6',
                    pointRadius: 4,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { borderDash: [5, 5] }, ticks: { callback: v => v.toLocaleString('vi-VN') + 'đ' } },
                    x: { grid: { display: false } }
                }
            }
        });

        // --- 2. Order Count Bar Chart ---
        const ctxOrder = document.getElementById('orderCountChart').getContext('2d');
        const gradBlue = ctxOrder.createLinearGradient(0,0,0,200);
        gradBlue.addColorStop(0, '#3b82f6'); gradBlue.addColorStop(1, '#93c5fd');

        new Chart(ctxOrder, {
            type: 'bar',
            data: {
                labels: @Html.Raw(orderLabels),
                datasets: [{ label: 'Số đơn', data: @Html.Raw(orderData), backgroundColor: gradBlue, borderRadius: 6 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
            }
        });

        // --- 3. Status Doughnut ---
        new Chart(document.getElementById('statusChart'), {
            type: 'doughnut',
            data: {
                labels: @Html.Raw(statusLabels),
                datasets: [{
                    data: @Html.Raw(statusData),
                    backgroundColor: ['#3b82f6', '#22c55e', '#ef4444', '#f59e0b', '#64748b'],
                    borderWidth: 0, hoverOffset: 10
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '70%',
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 15 } } }
            }
        });

        // --- 4. Category Bar Chart ---
        const ctxCat = document.getElementById('categoryChart').getContext('2d');
        const gradTeal = ctxCat.createLinearGradient(0,0,0,200);
        gradTeal.addColorStop(0, '#14b8a6'); gradTeal.addColorStop(1, '#5eead4');

        new Chart(ctxCat, {
            type: 'bar',
            data: {
                labels: @Html.Raw(catLabels),
                datasets: [{ label: 'Doanh thu', data: @Html.Raw(catData), backgroundColor: gradTeal, borderRadius: 6 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { display: false }, x: { grid: { display: false } } }
            }
        });
    </script>
}